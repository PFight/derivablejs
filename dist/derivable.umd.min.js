!function(t,n){"use strict";t&&"function"==typeof t.define&&t.define.amd?t.define(["exports"],n):n("undefined"!=typeof exports?exports:t.Derivable={})}(this,function(t){"use strict";function n(t){for(var n=1;n<arguments.length;n++)for(var e=arguments[n],r=X(e||{}),i=r.length;i--;){var u=r[i];t[u]=e[u]}return t}function e(t,n){return t===n?0!==t||1/t===1/n:t!==t&&n!==n}function r(t,n){return e(t,n)||t&&"function"==typeof t.equals&&t.equals(n)}function i(t,n){var e=t.indexOf(n);e<0&&t.push(n)}function u(t,n){var e=t.indexOf(n);e>=0&&t.splice(e,1)}function s(){return Y++}function o(t,n){return Array.prototype.slice.call(t,n)}function a(t){return null!==t&&void 0!==t}function c(t){$=!!t}function f(t,n){return t._equals=n,t}function h(t){return t&&(t._type===nt||t._type===tt||t._type===et)}function l(t){return t&&(t._type===tt||t._type===et)}function _(t){return t&&(t._type===nt||t._type===et)}function p(t){return t&&t._type===et}function v(t,n){at.push({parents:n,offset:0,child:t}),ct=t}function d(){return at[at.length-1]}function g(){at.pop(),ct=0===at.length?null:at[at.length-1].child}function y(t){if(null!==ct){var n=at[at.length-1];if(n.parents[n.offset]===t)n.offset++;else{var e=n.parents.indexOf(t);if(e===-1)i(t._activeChildren,ct),n.parents.push(n.parents[n.offset]),n.parents[n.offset]=t,n.offset++;else if(e>n.offset){var r=n.parents[e];n.parents[e]=n.parents[n.offset],n.parents[n.offset]=r,n.offset++}}}}function m(t,n){for(var e=0,r=t._activeChildren.length;e<r;e++){var i=t._activeChildren[e];switch(i._type){case nt:case et:i._state!==it&&(i._state=it,m(i,n));break;case rt:n.push(i)}}}function w(t){for(var n=0,e=t.length;n<e;n++){var r=t[n];if(r._reacting)throw new Error("Synchronous cyclical reactions disallowed. Use setImmediate.");r._maybeReact()}}function E(){throw ft}function b(t){this.parent=t,this.id2originalValue={},this.modifiedAtoms=[]}function k(t){null!==ht&&(t._id in ht.id2originalValue||(ht.modifiedAtoms.push(t),ht.id2originalValue[t._id]=t._value))}function q(){return null!==ht}function A(t){D();
try{t.call(null,E)}catch(n){if(T(),n!==ft)throw n;return}R()}function O(t){q()?t():A(t)}function x(t){return function(){var n,e=o(arguments,0),r=this;return A(function(){n=t.apply(r,e)}),n}}function C(t){return function(){var n,e=o(arguments,0),r=this;return O(function(){n=t.apply(r,e)}),n}}function D(){ht=new b(ht)}function R(){var t=ht;if(ht=t.parent,null===ht){var n=[];t.modifiedAtoms.forEach(function(e){e.__equals(e._value,t.id2originalValue[e._id])?e._state=st:(e._state=ut,m(e,n))}),w(n),t.modifiedAtoms.forEach(function(t){t._state=st})}}function T(){var t=ht;ht=t.parent,t.modifiedAtoms.forEach(function(n){n._value=t.id2originalValue[n._id],n._state=st,m(n,[])})}function j(){0===lt&&D(),lt++;var t=!1;return{tick:function(){if(t)throw new Error("trying to use ticker after release");R(),D()},reset:function(){if(t)throw new Error("trying to use ticker after release");T(),D()},release:function(){if(t)throw new Error("ticker already released");lt--,t=!0,0===lt&&R()}}}function V(t){this._deriver=t,this._parents=null,this._type=nt,this._value=Z,this._equals=null,this._activeChildren=[],this._state=ot,$&&(this.stack=Error().stack)}function F(t,n){if(u(t._activeChildren,n),0===t._activeChildren.length&&null!=t._parents){for(var e=t._parents.length,r=0;r<e;r++)F(t._parents[r],t);t._parents=null,t._state=ot}}function I(t){return new V(t)}function N(t,n,e){this._parent=t,this.react=n,this._governor=e||null,this._active=!1,this._reacting=!1,this._type=rt,$&&(this.stack=Error().stack)}function S(t,e,r){function i(t,n){if(!h(t)){if("function"==typeof t)return I(t);if("boolean"==typeof t)return I(function(){return t});throw Error("react "+n+" condition must be derivable, got: "+JSON.stringify(t))}return t}if("function"!=typeof e)throw Error("the first argument to .react must be a function");r=n({once:!1,from:!0,until:!1,when:!0,skipFirst:!1},r);var u=new N(t,function(t){r.skipFirst?r.skipFirst=!1:(e(t),r.once&&(this.stop(),c.stop()))}),s=i(r.until,"until"),o=i(r.when,"when"),a=I(function(){return{until:s.get(),when:o.get()}}),c=new N(a,function(t){
t.until?(u.stop(),this.stop()):t.when?u._active||u.start().force():u._active&&u.stop()});u._governor=c;var f=i(r.from,"from"),l=new N(f,function(t){t&&(c.start().force(),this.stop())});l.start().force()}function z(t){return this._id=s(),this._activeChildren=[],this._value=t,this._state=st,this._type=tt,this._equals=null,this}function L(t){return new z(t)}function M(t){V.call(this,t.get),this._lensDescriptor=t,this._type=et}function J(t){return new M(t)}function U(t){var n=o(arguments,1);return Et(function(){for(var e="",r=0;r<t.length;r++)e+=t[r],r<n.length&&(e+=B(n[r]));return e})}function B(t){return gt(t)?t.get():t}function G(t){return function(){var n=arguments,e=this;return Et(function(){return t.apply(e,Array.prototype.map.call(n,B))})}}function H(t){if(gt(t))return t.get();if(t instanceof Array)return t.map(H);if(t.constructor===Object){for(var n={},e=X(t),r=e.length;r--;){var i=e[r];n[i]=H(t[i])}return n}return t}function K(t){if(t.constructor===Object||t instanceof Array)return Et(function(){return H(t)});throw new Error("`struct` expects plain Object or Array")}function P(t){return function(){var n=arguments;return Et(function(){for(var e,r=0;r<n.length&&(e=B(n[r]),!t(e));r++);return e})}}function Q(t){return t}function W(t){return function(n){return!t(n)}}var X=Object.keys,Y=0,Z=Object.freeze({equals:function(){return!1}}),$=!1,tt="ATOM",nt="DERIVATION",et="LENS",rt="REACTOR",it=0,ut=1,st=2,ot=3,at=[],ct=null,ft={},ht=null,lt=0;n(V.prototype,{_clone:function(){return f(I(this._deriver),this._equals)},_forceEval:function(){var t,n=this,e=null;try{if(null===this._parents&&(this._parents=[]),v(this,this._parents),$)try{e=n._deriver()}catch(r){throw console.error(n.stack),r}else e=n._deriver();t=d().offset}finally{g()}for(this._state=this.__equals(e,this._value)?st:ut;t<this._parents.length;){var i=this._parents[t++];F(i,this)}this._value=e},_update:function(){if(null===this._parents)this._forceEval();else if(this._state===it)for(var t=this._parents.length,n=0;n<t;n++)if(this._parents[n]._state!==st){this._forceEval();
break}},get:function(){return this._activeChildren.length>0?(y(this),this._update(),this._value):this._deriver()}}),n(N.prototype,{start:function(){return this._active=!0,i(this._parent._activeChildren,this),this._parent._state===ot&&(this._parent._state=it),this._parent.get(),this},_force:function(t){try{this._reacting=!0,this.react(t)}catch(n){throw $&&console.error(this.stack),n}finally{this._reacting=!1}},force:function(){return this._force(this._parent.get()),this},_maybeReact:function(){if(!this._reacting&&this._active&&(null!==this._governor&&this._governor._maybeReact(),this._active)){var t=this._parent.get();this._parent._state===ut&&this._force(t)}},stop:function(){return F(this._parent,this),this._active=!1,this}}),n(z.prototype,{_clone:function(){return f(L(this._value),this._equals)},set:function(t){k(this);var n=this._value;if(this._value=t,!q()&&!this.__equals(t,n))try{this._state=ut;var e=[];m(this,e),w(e)}finally{this._state=st}},get:function(){return y(this),this._value}}),n(M.prototype,V.prototype,{_clone:function(){return f(new M(this._lensDescriptor),this._equals)},set:function(t){var n=this;return O(function(){n._lensDescriptor.set(t)}),this}});var _t=A,pt=c,vt=x,dt=j,gt=h,yt=l,mt=p,wt=_,Et=I,bt=L,kt=C,qt=O,At=J,Ot=P(Q),xt=P(a),Ct=P(W(Q)),Dt=P(W(a)),Rt=Object.freeze({transact:_t,setDebugMode:pt,transaction:vt,ticker:dt,isDerivable:gt,isAtom:yt,isLensed:mt,isDerivation:wt,derivation:Et,atom:bt,atomic:kt,atomically:qt,lens:At,derive:U,unpack:B,lift:G,struct:K,or:Ot,mOr:xt,and:Ct,mAnd:Dt}),Tt={derive:function(t,n,e,r,i){var u=this;switch(arguments.length){case 0:throw new Error(".derive takes at least one argument");case 1:switch(typeof t){case"function":return Et(function(){return t(u.get())});case"string":case"number":return Et(function(){return u.get()[B(t)]});default:if(t instanceof Array)return t.map(function(t){return u.derive(t)});if(t instanceof RegExp)return Et(function(){return u.get().match(t)});if(h(t))return Et(function(){var n=t.get(),e=u.get();switch(typeof n){case"function":return n(e);
case"string":case"number":return e[n];default:if(n instanceof RegExp)return e.match(n);throw Error("type error")}});throw Error("type error")}case 2:return Et(function(){return t(u.get(),B(n))});case 3:return Et(function(){return t(u.get(),B(n),B(e))});case 4:return Et(function(){return t(u.get(),B(n),B(e),B(r))});case 5:return Et(function(){return t(u.get(),B(n),B(e),B(r),B(i))});default:var s=[u].concat(o(arguments,1));return Et(function(){return t.apply(null,s.map(B))})}},react:function(t,n){S(this,t,n)},is:function(t){return G(this._equals||r)(this,t)},and:function(t){return this.derive(function(n){return n&&B(t)})},or:function(t){return this.derive(function(n){return n||B(t)})},then:function(t,n){return this.derive(function(e){return B(e?t:n)})},mThen:function(t,n){return this.derive(function(e){return B(a(e)?t:n)})},mOr:function(t){return this.mThen(this,t)},mDerive:function(t){if(1===arguments.length&&t instanceof Array){var n=this;return t.map(function(t){return n.mDerive(t)})}return this.mThen(this.derive.apply(this,arguments))},mAnd:function(t){return this.mThen(t,this)},not:function(){return this.derive(function(t){return!t})},withEquality:function(t){if(t){if("function"!=typeof t)throw new Error("equals must be function")}else t=null;return f(this._clone(),t)},__equals:function(t,n){return(this._equals||r)(t,n)}};Tt["switch"]=function(){var t=arguments,n=this;return this.derive(function(e){var r;for(r=0;r<t.length-1;r+=2)if(n.__equals(e,B(t[r])))return B(t[r+1]);if(r===t.length-1)return B(t[r])})};var jt={swap:function(t){var n=o(arguments,0);return n[0]=this.get(),this.set(t.apply(null,n))},lens:function(t){var n=this;return new M({get:function(){return t.get(n.get())},set:function(e){n.set(t.set(n.get(),e))}})}};n(V.prototype,Tt),n(M.prototype,Tt,jt),n(z.prototype,Tt,jt),module.exports=Rt,module.exports=Rt});
//# sourceMappingURL=dist/derivable.umd.min.js.map
//# sourceMappingURL=derivable.umd.min.js.map