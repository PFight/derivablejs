!function(t,n){"use strict";t&&"function"==typeof t.define&&t.define.amd?t.define(["exports"],n):n("undefined"!=typeof exports?exports:t.Derivable={})}(this,function(t){"use strict";function n(t){for(var n=1;n<arguments.length;n++)for(var e=arguments[n],r=Y(e||{}),i=r.length;i--;){var u=r[i];t[u]=e[u]}return t}function e(t,n){return t===n?0!==t||1/t===1/n:t!==t&&n!==n}function r(t,n){return e(t,n)||t&&"function"==typeof t.equals&&t.equals(n)}function i(t,n){var e=t.indexOf(n);e<0&&t.push(n)}function u(t,n){var e=t.indexOf(n);e>=0&&t.splice(e,1)}function o(){return Z++}function s(t,n){return Array.prototype.slice.call(t,n)}function a(t){return null!==t&&void 0!==t}function c(t){tt=!!t}function f(t,n){return t._equals=n,t}function h(t){return t&&(t._type===et||t._type===nt||t._type===rt)}function l(t){return t&&(t._type===nt||t._type===rt)}function _(t){return t&&(t._type===et||t._type===rt)}function p(t){return t&&t._type===rt}function v(t,n){ct.push({parents:n,offset:0,child:t}),ft=t}function d(){return ct[ct.length-1]}function g(){ct.pop(),ft=0===ct.length?null:ct[ct.length-1].child}function y(t){if(null!==ft){var n=ct[ct.length-1];if(n.parents[n.offset]===t)n.offset++;else{var e=n.parents.indexOf(t);if(e===-1)i(t._activeChildren,ft),n.parents.push(n.parents[n.offset]),n.parents[n.offset]=t,n.offset++;else if(e>n.offset){var r=n.parents[e];n.parents[e]=n.parents[n.offset],n.parents[n.offset]=r,n.offset++}}}}function m(t,n){for(var e=0,r=t._activeChildren.length;e<r;e++){var i=t._activeChildren[e];switch(i._type){case et:case rt:i._state!==ut&&(i._state=ut,m(i,n));break;case it:n.push(i)}}}function w(t){for(var n=0,e=t.length;n<e;n++){var r=t[n];if(r._reacting)throw new Error("Synchronous cyclical reactions disallowed. Use setImmediate.");r._maybeReact()}}function E(){throw ht}function b(t){this.parent=t,this.id2originalValue={},this.modifiedAtoms=[]}function k(t){null!==lt&&(t._id in lt.id2originalValue||(lt.modifiedAtoms.push(t),lt.id2originalValue[t._id]=t._value))}function A(){return null!==lt}function q(t){x();
try{t.call(null,E)}catch(n){if(j(),n!==ht)throw n;return}R()}function O(t){A()?t():q(t)}function D(t){return function(){var n,e=s(arguments,0),r=this;return q(function(){n=t.apply(r,e)}),n}}function C(t){return function(){var n,e=s(arguments,0),r=this;return O(function(){n=t.apply(r,e)}),n}}function x(){lt=new b(lt)}function R(){var t=lt;if(lt=t.parent,null===lt){var n=[];t.modifiedAtoms.forEach(function(e){e.__equals(e._value,t.id2originalValue[e._id])?e._state=st:(e._state=ot,m(e,n))}),w(n),t.modifiedAtoms.forEach(function(t){t._state=st})}}function j(){var t=lt;lt=t.parent,t.modifiedAtoms.forEach(function(n){n._value=t.id2originalValue[n._id],n._state=st,m(n,[])})}function T(){0===_t&&x(),_t++;var t=!1;return{tick:function(){if(t)throw new Error("trying to use ticker after release");R(),x()},reset:function(){if(t)throw new Error("trying to use ticker after release");j(),x()},release:function(){if(t)throw new Error("ticker already released");_t--,t=!0,0===_t&&R()}}}function V(t){this._deriver=t,this._parents=null,this._type=et,this._value=$,this._equals=null,this._activeChildren=[],this._state=at,tt&&(this.stack=Error().stack)}function S(t,n){if(u(t._activeChildren,n),0===t._activeChildren.length&&null!=t._parents){for(var e=t._parents.length,r=0;r<e;r++)S(t._parents[r],t);t._parents=null,t._state=at}}function M(t){return new V(t)}function F(t,n,e){this._parent=t,this.react=n,this._governor=e||null,this._active=!1,this._reacting=!1,this._type=it,tt&&(this.stack=Error().stack)}function I(t,e,r){function i(t,n){if(!h(t)){if("function"==typeof t)return M(t);if("boolean"==typeof t)return M(function(){return t});throw Error("react "+n+" condition must be derivable, got: "+JSON.stringify(t))}return t}if("function"!=typeof e)throw Error("the first argument to .react must be a function");r=n({once:!1,from:!0,until:!1,when:!0,skipFirst:!1},r);var u=new F(t,function(t){r.skipFirst?r.skipFirst=!1:(e(t),r.once&&(this.stop(),c.stop()))}),o=i(r.until,"until"),s=i(r.when,"when"),a=M(function(){return{until:o.get(),when:s.get()
}}),c=new F(a,function(t){t.until?(u.stop(),this.stop()):t.when?u._active||u.start().force():u._active&&u.stop()});u._governor=c;var f=i(r.from,"from"),l=new F(f,function(t){t&&(c.start().force(),this.stop())});l.start().force()}function L(t){return this._id=o(),this._activeChildren=[],this._value=t,this._state=st,this._type=nt,this._equals=null,this}function N(t){return new L(t)}function P(t){V.call(this,t.get),this._lensDescriptor=t,this._type=rt}function z(t){return new P(t)}function J(t){var n=s(arguments,1);return bt(function(){for(var e="",r=0;r<t.length;r++)e+=t[r],r<n.length&&(e+=U(n[r]));return e})}function U(t){return yt(t)?t.get():t}function B(t){return function(){var n=arguments,e=this;return bt(function(){return t.apply(e,Array.prototype.map.call(n,U))})}}function G(t){if(yt(t))return t.get();if(t instanceof Array)return t.map(G);if(t.constructor===Object){for(var n={},e=Y(t),r=e.length;r--;){var i=e[r];n[i]=G(t[i])}return n}return t}function H(t){if(t.constructor===Object||t instanceof Array)return bt(function(){return G(t)});throw new Error("`struct` expects plain Object or Array")}function K(t,n){var e=n;return function(n){var r=t.call(this,n,e);return e=n,r}}function Q(t){return function(){var n=arguments;return bt(function(){for(var e,r=0;r<n.length&&(e=U(n[r]),!t(e));r++);return e})}}function W(t){return t}function X(t){return function(n){return!t(n)}}Object.defineProperty(t,"__esModule",{value:!0});var Y=Object.keys,Z=0,$=Object.freeze({equals:function(){return!1}}),tt=!1,nt="ATOM",et="DERIVATION",rt="LENS",it="REACTOR",ut=0,ot=1,st=2,at=3,ct=[],ft=null,ht={},lt=null,_t=0;n(V.prototype,{_clone:function(){return f(M(this._deriver),this._equals)},_forceEval:function(){var t,n=this,e=null;try{if(null===this._parents&&(this._parents=[]),v(this,this._parents),tt)try{e=n._deriver()}catch(r){throw console.error(n.stack),r}else e=n._deriver();t=d().offset}finally{g()}for(this._state=this.__equals(e,this._value)?st:ot;t<this._parents.length;){var i=this._parents[t++];S(i,this)}this._value=e},_update:function(){
if(null===this._parents)this._forceEval();else if(this._state===ut)for(var t=this._parents.length,n=0;n<t;n++){var e=this._parents[n];if(e._state===ut&&e._update(),e._state===ot){this._forceEval();break}}},get:function(){return this._activeChildren.length>0?(y(this),this._update(),this._value):this._deriver()}}),n(F.prototype,{start:function(){return this._active=!0,i(this._parent._activeChildren,this),this._parent.get(),this},_force:function(t){try{this._reacting=!0,this.react(t)}catch(n){throw tt&&console.error(this.stack),n}finally{this._reacting=!1}},force:function(){return this._force(this._parent.get()),this},_maybeReact:function(){if(!this._reacting&&this._active&&(null!==this._governor&&this._governor._maybeReact(),this._active)){var t=this._parent.get();this._parent._state===ot&&this._force(t)}},stop:function(){return S(this._parent,this),this._active=!1,this}}),n(L.prototype,{_clone:function(){return f(N(this._value),this._equals)},set:function(t){k(this);var n=this._value;if(this._value=t,!A()&&!this.__equals(t,n))try{this._state=ot;var e=[];m(this,e),w(e)}finally{this._state=st}},get:function(){return y(this),this._value}}),n(P.prototype,V.prototype,{_clone:function(){return f(new P(this._lensDescriptor),this._equals)},set:function(t){var n=this;return O(function(){n._lensDescriptor.set(t)}),this}});var pt=q,vt=c,dt=D,gt=T,yt=h,mt=l,wt=p,Et=_,bt=M,kt=N,At=C,qt=O,Ot=z,Dt=Q(W),Ct=Q(a),xt=Q(X(W)),Rt=Q(X(a)),jt=Object.freeze({transact:pt,setDebugMode:vt,transaction:dt,ticker:gt,isDerivable:yt,isAtom:mt,isLensed:wt,isDerivation:Et,derivation:bt,atom:kt,atomic:At,atomically:qt,lens:Ot,derive:J,unpack:U,lift:B,struct:H,wrapPreviousState:K,or:Dt,mOr:Ct,and:xt,mAnd:Rt}),Tt={derive:function(t,n,e,r,i){var u=this;switch(arguments.length){case 0:throw new Error(".derive takes at least one argument");case 1:switch(typeof t){case"function":return bt(function(){return t(u.get())});case"string":case"number":return bt(function(){return u.get()[U(t)]});default:if(t instanceof Array)return t.map(function(t){return u.derive(t);
});if(t instanceof RegExp)return bt(function(){return u.get().match(t)});if(h(t))return bt(function(){var n=t.get(),e=u.get();switch(typeof n){case"function":return n(e);case"string":case"number":return e[n];default:if(n instanceof RegExp)return e.match(n);throw Error("type error")}});throw Error("type error")}case 2:return bt(function(){return t(u.get(),U(n))});case 3:return bt(function(){return t(u.get(),U(n),U(e))});case 4:return bt(function(){return t(u.get(),U(n),U(e),U(r))});case 5:return bt(function(){return t(u.get(),U(n),U(e),U(r),U(i))});default:var o=[u].concat(s(arguments,1));return bt(function(){return t.apply(null,o.map(U))})}},react:function(t,n){I(this,t,n)},is:function(t){return B(this._equals||r)(this,t)},and:function(t){return this.derive(function(n){return n&&U(t)})},or:function(t){return this.derive(function(n){return n||U(t)})},then:function(t,n){return this.derive(function(e){return U(e?t:n)})},mThen:function(t,n){return this.derive(function(e){return U(a(e)?t:n)})},mOr:function(t){return this.mThen(this,t)},mDerive:function(t){if(1===arguments.length&&t instanceof Array){var n=this;return t.map(function(t){return n.mDerive(t)})}return this.mThen(this.derive.apply(this,arguments))},mAnd:function(t){return this.mThen(t,this)},not:function(){return this.derive(function(t){return!t})},withEquality:function(t){if(t){if("function"!=typeof t)throw new Error("equals must be function")}else t=null;return f(this._clone(),t)},__equals:function(t,n){return(this._equals||r)(t,n)}};Tt["switch"]=function(){var t=arguments,n=this;return this.derive(function(e){var r;for(r=0;r<t.length-1;r+=2)if(n.__equals(e,U(t[r])))return U(t[r+1]);if(r===t.length-1)return U(t[r])})};var Vt={swap:function(t){var n=s(arguments,0);return n[0]=this.get(),this.set(t.apply(null,n))},lens:function(t){var n=this;return new P({get:function(){return t.get(n.get())},set:function(e){n.set(t.set(n.get(),e))}})}};n(V.prototype,Tt),n(P.prototype,Tt,Vt),n(L.prototype,Tt,Vt);var St=pt,Mt=vt,Ft=dt,It=gt,Lt=yt,Nt=mt,Pt=wt,zt=Et,Jt=bt,Ut=kt,Bt=At,Gt=qt,Ht=Ot,Kt=J,Qt=U,Wt=B,Xt=H,Yt=K,Zt=Dt,$t=Ct,tn=xt,nn=Rt;
t.transact=St,t.setDebugMode=Mt,t.transaction=Ft,t.ticker=It,t.isDerivable=Lt,t.isAtom=Nt,t.isLensed=Pt,t.isDerivation=zt,t.derivation=Jt,t.atom=Ut,t.atomic=Bt,t.atomically=Gt,t.lens=Ht,t.derive=Kt,t.unpack=Qt,t.lift=Wt,t.struct=Xt,t.wrapPreviousState=Yt,t.or=Zt,t.mOr=$t,t.and=tn,t.mAnd=nn,t["default"]=jt});
//# sourceMappingURL=dist/derivable.umd.min.js.map
//# sourceMappingURL=derivable.umd.min.js.map