!function(t,n){"use strict";t&&"function"==typeof t.define&&t.define.amd?t.define(["exports"],n):n("undefined"!=typeof exports?exports:t.Havelock={})}(this,function(t){"use strict";function n(t){for(var n=1;n<arguments.length;n++){var e=arguments[n];J(e).forEach(function(n){t[n]=e[n]})}return t}function e(t){return Object.prototype.toString.call(t).slice(8,-1)}function r(t,n){return t===n?0!==t||1/t===1/n:t!==t&&n!==n}function i(t,n,r,i){var a=e(t);if(a!==e(n))return!1;if("Boolean"===a||"Number"===a||"String"===a)return"object"==typeof t?"object"==typeof n&&u(t.valueOf(),n.valueOf()):!1;if("RegExp"===a)return t.source===n.source&&t.global===n.global&&t.ignoreCase===n.ignoreCase&&t.multiline===n.multiline&&t.sticky===n.sticky&&t.unicode===n.unicode;if(Object(t)===t){if("Date"===a&&t.getTime()!==n.getTime())return!1;var o=Object.keys(t);if(o.length!==Object.keys(n).length)return!1;r||(r=[],i=[]);for(var c=r.length-1;c>=0;){if(r[c]===t)return i[c]===n;c-=1}for(r[r.length]=t,i[i.length]=n,c=o.length-1;c>=0;){var s=o[c];if(!Object.hasOwnProperty(s,n)||!u(n[s],t[s],r,i))return!1;c-=1}return r.pop(),i.pop(),!0}return!1}function u(t,n,e,u){return Object.is&&Object.is(t,n)||r(t,n)?!0:t&&n?"function"==typeof t.equals&&t.equals(n)||"function"==typeof n.equals&&n.equals(t)||i(t,n,e,u)||!1:!1}function a(t,n){var e=t.indexOf(n);0>e&&t.push(n)}function o(t,n){var e=t.indexOf(n);e>=0&&t.splice(e,1)}function c(t,n){return t.indexOf(n)>=0}function s(){return K++}function f(t,n){return Array.prototype.slice.call(t,n)}function l(t,n){if(t._type===ot)n.push(t);else for(var e=t._children.length;e--;){var r=t._children[e];r._state!==tt&&(r._state=tt,l(r,n))}}function h(t){switch(t._state){case Y:case Z:for(var n=t._children.length;n--;){var e=t._children[n];h(e),e._state!==nt&&t._children.splice(n,1)}t._state=nt;break;case tt:for(var r=[],n=t._parents.length;n--;){var i=t._parents[n];if(i._state!==Z){t._state=$;break}r.push([i,i._value])}t._state!==$&&(t._state=et,t._parents=r);break;case nt:case $:case et:break;default:throw Error("can't sweep state "+t._state);
}}function p(t){return rt.push([]),t(),rt.pop()}function _(t){rt.length>0&&a(rt[rt.length-1],t)}function v(){throw lt}function g(){return{currentTxn:null}}function d(t){return null!==t.currentTxn}function y(t){return t.currentTxn}function b(t,n){n._parent=t.currentTxn,n._state=ct,t.currentTxn=n}function m(t,n){var e=t.currentTxn;if(t.currentTxn=e._parent,e._state!==ct)throw Error("unexpected state: "+e._state);n(e)}function k(t){m(t,function(t){t._state=st,t.onCommit&&t.onCommit()})}function w(t){m(t,function(t){t._state=ft,t.onAbort&&t.onAbort()})}function x(t,n,e){b(t,n);try{e(v)}catch(r){if(w(t),r!==lt)throw r;return}k(t)}function T(t,n){return{control:n,parent:t,_state:nt,active:!1,_type:ot}}function O(t){o(t.parent._children,t),t.active=!1,t.control.onStop&&t.control.onStop()}function E(t){a(t.parent._children,t),t.active=!0,t.control.onStart&&t.control.onStart(),t.parent._get()}function j(t){if(t._state===tt){var n=t.parent,e=n._state;if((e===tt||e===$||e===et||e===X)&&n._get(),e=n._state,e===Z)t._state=nt;else{if(e!==Y)throw Error("invalid parent state: "+e);V(t)}}}function V(t){if(!t.control.react)throw Error("No reaction function available.");t._state=nt,t.control.react(t.parent._get())}function q(){this._type=ot}function A(t,n){if(t._base)throw Error("This reaction has already been initialized");return t._base=T(n,t),t}function C(t){q.call(this),this.react=t}function S(t){return n(new q,t)}function D(t,n){var e={derive:function(n,e,r,i,u){var a=this;switch(arguments.length){case 0:return a;case 1:return t.derivation(function(){return n(a.get())});case 2:return t.derivation(function(){return n(a.get(),t.unpack(e))});case 3:return t.derivation(function(){return n(a.get(),t.unpack(e),t.unpack(r))});case 4:return t.derivation(function(){return n(a.get(),t.unpack(e),t.unpack(r),t.unpack(i))});case 5:return t.derivation(function(){return n(a.get(),t.unpack(e),t.unpack(r),t.unpack(i),t.unpack(u))});default:var o=[a].concat(f(arguments,1));return t.derivation(function(){return n.apply(null,o.map(t.unpack))})}},reaction:function(t){
if("function"==typeof t)return A(new C(t),this);if(t instanceof q)return A(t,this);if(t&&t.react)return A(S(t),this);throw Error("Unrecognized type for reaction "+t)},react:function(t){return this.reaction(t).start().force()},get:function(){return _(this),this._get()},is:function(e){return t.lift(n.equals)(this,e)},and:function(n){return this.derive(function(e){return e&&t.unpack(n)})},or:function(n){return this.derive(function(e){return e||t.unpack(n)})},then:function(n,e){return this.derive(function(r){return t.unpack(r?n:e)})},not:function(){return this.derive(function(t){return!t})}};return e["switch"]=function(){var e=arguments;return this.derive(function(r){var i;for(i=0;e.length-1>i;i+=2)if(n.equals(r,t.unpack(e[i])))return t.unpack(e[i+1]);return i===e.length-1?t.unpack(e[i]):void 0})},e}function R(t,n){return{_clone:function(){return t.derivation(this._deriver)},_forceGet:function(){for(var t=this,e=p(function(){var e=t._deriver();t._state=n.equals(e,t._value)?Z:Y,t._value=e}),r=this._parents.length;r--;){var i=this._parents[r];c(e,i)||o(i._children,this)}this._parents=e;for(var r=e.length;r--;)a(e[r]._children,this)},_get:function(){t:switch(this._state){case X:case $:this._forceGet();break;case tt:for(var t=this._parents.length;t--;){var e=this._parents[t],r=e._state;if((r===tt||r===$||r===et)&&e._get(),r=e._state,r===Y){this._forceGet();break t}if(r!==nt&&r!==Z)throw Error("invalid parent mode: "+r)}this._state=Z;break;case et:for(var i=[],t=this._parents.length;t--;){var u=this._parents[t],e=u[0],o=u[1];if(!n.equals(e._get(),o)){this._parents=[],this._forceGet();break t}i.push(e)}for(var t=i.length;t--;)a(i[t]._children,this);this._parents=i,this._state=Z}return this._value}}}function N(t,n){return t._children=[],t._parents=[],t._deriver=n,t._state=X,t._type=ut,t._value={},t}function G(t){return{swap:function(t){var n=f(arguments,0);return n[0]=this.get(),this.set(t.apply(null,n))},lens:function(n){return t.lens(this,n)}}}function I(t){return{_clone:function(){return t.lens(this._parent,{get:this._getter,
set:this._setter})},set:function(t){return this._parent.set(this._setter(this._parent._get(),t)),this}}}function Q(t,n,e){return t._getter=e.get,t._setter=e.set,t._parent=n,t._type=at,t}function z(t){ht=!0;try{for(var n=t.length;n--;)j(t[n])}finally{ht=!1}}function L(){this.inTxnValues={},this.reactionQueue=[]}function U(t,n){var e=t.inTxnValues[n._uid];return e?e[1]:n._value}function B(t,n,e){t.inTxnValues[n._uid]=[n,e],l(n,t.reactionQueue)}function F(t,n){return{_clone:function(){return t.atom(this._value)},withValidator:function(t){if(null===t)return this._clone();if("function"==typeof t){var n=this._clone(),e=this._validator;return n._validator=e?function(n){return t(n)&&e(n)}:t,n}throw Error(".withValidator expects function or null")},validate:function(){this._validate(this.get())},_validate:function(t){var n=this._validator&&this._validator(t);if(this._validator&&n!==!0)throw Error("Failed validation with value: '"+t+"'. Validator returned '"+n+"' ")},set:function(t){if(ht)throw Error("Trying to set atom state during reaction phase. This is an error. Use middleware for cascading changes.");if(this._validate(t),!n.equals(t,this._value))if(this._state=Y,d(pt))B(y(pt),this,t);else{this._value=t;var e=[];l(this,e),z(e),h(this)}return this},_get:function(){return d(pt)?U(y(pt),this):this._value}}}function H(t,n){return t._uid=s(),t._children=[],t._state=nt,t._value=n,t._type=it,t}function M(t){x(pt,new L,t)}function P(t){return function(){var n=f(arguments,0),e=this;M(function(){t.apply(e,n)})}}function W(t){function e(t){var n=f(arguments,1);return i.derivation(function(){for(var e="",r=0;t.length>r;r++)e+=t[r],n.length>r&&(e+=i.unpack(n[r]));return e})}function r(t){if(i.isDerivable(t))return t.get();if(t instanceof Array)return t.map(r);if(t.constructor===Object){for(var n={},e=J(t),u=e.length;u--;){var a=e[u];n[a]=r(t[a])}return n}return t}t=n({},vt,t||{});var i={transact:M,transaction:P,Reaction:q,isAtom:function(t){return t&&(t._type===it||t._type===at)},isDerivable:function(t){return t&&(t._type===it||t._type===at||t._type===ut);
},isDerivation:function(t){return t&&(t._type===ut||t._type===at)},isLensed:function(t){return t&&t._type===at},isReaction:function(t){return t&&t._type===ot}},u=D(i,t),a=G(i,t),o=n({},a,u,F(i,t)),c=n({},u,R(i,t)),s=n({},a,c,I(i,t));return i.atom=function(t){return H(Object.create(o),t)},i.swap=function(t,n){var e=f(arguments,1);return e[0]=t.get(),t.set(n.apply(null,e))},i.derivation=function(t){return N(Object.create(c),t)},i.derive=function(t){if(t instanceof Array)return e.apply(null,arguments);if(arguments.length>0)return u.derive.apply(t,f(arguments,1));throw Error("Wrong arity for derive. Expecting 1+ args")},i.lens=function(t,n){var e=Object.create(s);return Q(N(e,function(){return n.get(t.get())}),t,n)},i.unpack=function(t){return i.isDerivable(t)?t.get():t},i.lift=function(t){return function(){var n=arguments,e=this;return i.derivation(function(){return t.apply(e,Array.prototype.map.call(n,i.unpack))})}},i.set=function(t,n){return t.set(n)},i.get=function(t){return t.get()},i.struct=function(t){return i.derivation(function(){return r(t)})},i.ifThenElse=function(t,n,e){return t.then(n,e)},i.or=function(){var t=arguments;return i.derivation(function(){for(var n,e=0;t.length>e&&!(n=i.unpack(t[e]));e++);return n})},i.and=function(){var t=arguments;return i.derivation(function(){for(var n,e=0;t.length>e&&(n=i.unpack(t[e]),n);e++);return n})},i.not=function(t){return t.derive(function(t){return!t})},i.switchCase=function(t){return u["switch"].apply(t,f(arguments,1))},i}var J=Object.keys,K=0,X=0,Y=1,Z=2,$=3,tt=4,nt=5,et=6;const rt=[];var it="ATOM",ut="DERIVATION",at="LENS",ot="REACTION",ct=0,st=1,ft=3,lt={};n(q.prototype,{start:function(){return E(this._base),this},stop:function(){return O(this._base),this},force:function(){return V(this._base),this},isRunning:function(){return this._base.active}}),n(C.prototype,q.prototype);var ht=!1,pt=g(),_t={push:function(){}};n(L.prototype,{onCommit:function(){var t=J(this.inTxnValues);if(d(pt))for(var n=t.length;n--;){var e=this.inTxnValues[t[n]];e[0].set(e[1])}else{for(var n=t.length;n--;){
var e=this.inTxnValues[t[n]];e[0]._value=e[1],l(e[0],_t)}z(this.reactionQueue);for(var n=t.length;n--;)h(this.inTxnValues[t[n]][0])}},onAbort:function(){if(!d(pt))for(var t=J(this.inTxnValues),n=t.length;n--;)h(this.inTxnValues[t[n]][0])}});var vt={equals:u};n(t,W()),t.withEquality=function(t){return W({equals:t})},t["default"]=t});
//# sourceMappingURL=dist/havelock.min.js.map