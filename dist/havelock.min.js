/**
 *  Copyright (c) 2015, David Sheldrick.
 *  All rights reserved.
 *
 *  This source code is licensed under the BSD-style license found in the
 *  LICENSE file in the root directory of this source tree.
 */
function t(t,r,e){return r in t?Object.defineProperty(t,r,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[r]=e,t}function r(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(t,r):t.__proto__=r)}function e(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}var n=function(){function t(t,r){var e=[],n=!0,i=!1,a=void 0;try{for(var o,u=t[Symbol.iterator]();!(n=(o=u.next()).done)&&(e.push(o.value),!r||e.length!==r);n=!0);}catch(s){i=!0,a=s}finally{try{!n&&u["return"]&&u["return"]()}finally{if(i)throw a}}return e}return function(r,e){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return t(r,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i=function o(t,r,e){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,r);if(void 0===n){var i=Object.getPrototypeOf(t);return null===i?void 0:o(i,r,e)}if("value"in n)return n.value;var a=n.get;return void 0===a?void 0:a.call(e)},a=function(){function t(t,r){for(var e=0;r.length>e;e++){var n=r[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(r,e,n){return e&&t(r.prototype,e),n&&t(r,n),r}}();!function(t,r){"use strict";t&&"function"==typeof t.define&&t.define.amd?t.define(["exports"],r):r("undefined"!=typeof exports?exports:t.Havelock={})}(this,function(o){"use strict";function u(t){var r=!0,e=!1,n=void 0;try{for(var i=arguments.length,a=Array(i>1?i-1:0),o=1;i>o;o++)a[o-1]=arguments[o];for(var u,s=a[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){var c=u.value,l=!0,f=!1,h=void 0;try{for(var v,y=Object.keys(c)[Symbol.iterator]();!(l=(v=y.next()).done);l=!0){var _=v.value;t[_]=c[_]}}catch(d){f=!0,h=d}finally{try{!l&&y["return"]&&y["return"]()}finally{if(f)throw h}}}}catch(d){
e=!0,n=d}finally{try{!r&&s["return"]&&s["return"]()}finally{if(e)throw n}}return t}function s(t){return Object.getOwnPropertySymbols(t).map(function(r){return t[r]})}function c(t){return Object.prototype.toString.call(t).slice(8,-1)}function l(t,r){return t===r?0!==t||1/t===1/r:t!==t&&r!==r}function f(t,r,e,n){var i=c(t);if(i!==c(r))return!1;if("Boolean"===i||"Number"===i||"String"===i)return"object"==typeof t?"object"==typeof r&&h(t.valueOf(),r.valueOf()):!1;if("RegExp"===i)return t.source===r.source&&t.global===r.global&&t.ignoreCase===r.ignoreCase&&t.multiline===r.multiline&&t.sticky===r.sticky&&t.unicode===r.unicode;if(Object(t)===t){if("Date"===i&&t.getTime()!==r.getTime())return!1;var a=Object.keys(t);if(a.length!==Object.keys(r).length)return!1;e||(e=[],n=[]);for(var o=e.length-1;o>=0;){if(e[o]===t)return n[o]===r;o-=1}for(e[e.length]=t,n[n.length]=r,o=a.length-1;o>=0;){var u=a[o];if(!Object.hasOwnProperty(u,r)||!h(r[u],t[u],e,n))return!1;o-=1}return e.pop(),n.pop(),!0}return!1}function h(t,r,e,n){return Object.is&&Object.is(t,r)||l(t,r)?!0:t&&r?"function"==typeof t.equals&&t.equals(r)||"function"==typeof r.equals&&r.equals(t)||f(t,r,e,n)||!1:!1}function v(t,r){if(t._type===G)r.push(t);else{var e=!0,n=!1,i=void 0;try{for(var a,o=t._children[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var u=a.value;u._state!==C&&(u._state=C,v(u,r))}}catch(s){n=!0,i=s}finally{try{!e&&o["return"]&&o["return"]()}finally{if(n)throw i}}}}function y(t){switch(t._state){case q:case P:var r=!0,e=!1,n=void 0;try{for(var i,a=t._children[Symbol.iterator]();!(r=(i=a.next()).done);r=!0){var o=i.value;y(o)}}catch(u){e=!0,n=u}finally{try{!r&&a["return"]&&a["return"]()}finally{if(e)throw n}}t._state=N;break;case C:var s=[],c=!0,l=!1,f=void 0;try{for(var h,v=t._parents[Symbol.iterator]();!(c=(h=v.next()).done);c=!0){var _=h.value;_._state===q&&(t._state=R),_._children.remove(t),s.push([_,_._value])}}catch(u){l=!0,f=u}finally{try{!c&&v["return"]&&v["return"]()}finally{if(l)throw f}}t._state!==R&&(t._state=D,t._parents=s);break;case N:break;
default:throw Error("It should be impossible to sweep nodes with mode: "+t._state)}}function _(t){return W.push(new M),t(),W.pop()}function d(t){W.length>0&&W[W.length-1].add(t)}function p(){throw Z}function b(t){return u(new rt,t)}function m(r,e){var n=e.equals;return t({derive:function(t){return r.derive(this,t)},reaction:function(t){if("function"==typeof t)return new et(t)._createBase(this);if(t instanceof rt)return t._createBase(this);if(t&&t.react)return b(t)._createBase(this);throw Error("Unrecognized type for reaction "+t)},react:function(t){return this.reaction(t).start().force()},get:function(){return d(this),this._get()},is:function(t){return r.lift(n)(this,t)},and:function(t){return this.derive(function(e){return e&&r.unpack(t)})},or:function(t){return this.derive(function(e){return e||r.unpack(t)})},then:function(t,e){return this.derive(function(n){return r.unpack(n?t:e)})},not:function(){return this.derive(function(t){return!t})}},"switch",function(){for(var t=arguments.length,e=Array(t),i=0;t>i;i++)e[i]=arguments[i];return this.derive(function(t){var i=void 0;for(i=0;e.length-1>i;i+=2)if(n(t,r.unpack(e[i])))return r.unpack(e[i+1]);return i===e.length-1?r.unpack(e[i]):void 0})})}function g(t,r){var e=r.equals;return{_clone:function(){return t.derive(this._deriver)},_forceGet:function(){var t=this,r=_(function(){var r=t._deriver();t._state=e(r,t._value)?P:q,t._value=r}),n=!0,i=!1,a=void 0;try{for(var o,u=this._parents[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value;r[s._uid]||s._children.remove(this)}}catch(c){i=!0,a=c}finally{try{!n&&u["return"]&&u["return"]()}finally{if(i)throw a}}this._parents=r;var l=!0,f=!1,h=void 0;try{for(var v,y=r[Symbol.iterator]();!(l=(v=y.next()).done);l=!0){var d=v.value;d._children.add(this)}}catch(c){f=!0,h=c}finally{try{!l&&y["return"]&&y["return"]()}finally{if(f)throw h}}},_get:function(){t:switch(this._state){case V:case R:this._forceGet();break;case C:var t=!0,r=!1,i=void 0;try{for(var a,o=this._parents[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var u=a.value;
switch((u._state===C||u._state===R||u._state===D)&&u._get(),u._state){case N:case P:break;case q:this._forceGet();break t;default:throw Error("invalid parent mode: "+u._state)}}}catch(s){r=!0,i=s}finally{try{!t&&o["return"]&&o["return"]()}finally{if(r)throw i}}this._state=P;break;case D:var c=new M,l=!0,f=!1,h=void 0;try{for(var v,y=this._parents[Symbol.iterator]();!(l=(v=y.next()).done);l=!0){var _=n(v.value,2),d=_[0],p=_[1];if(!e(d._get(),p)){this._parents=new M,this._forceGet();break t}c.add(d)}}catch(s){f=!0,h=s}finally{try{!l&&y["return"]&&y["return"]()}finally{if(f)throw h}}this._parents=c,this._state=P}return this._value}}}function w(t,r){return t._uid=Symbol("my_uid"),t._children=new M,t._parents=new M,t._deriver=r,t._state=V,t._type=z,t._value=Symbol("null"),t}function k(t){return{swap:function(t){for(var r=arguments.length,e=Array(r>1?r-1:0),n=1;r>n;n++)e[n-1]=arguments[n];return this.set(t.apply(null,[this.get()].concat(e)))},lens:function(r){return t.lens(this,r)}}}function S(t){return{_clone:function(){return t.lens(this._parent,{get:this._getter,set:this._setter})},set:function(t){return this._parent.set(this._setter(this._parent._get(),t)),this}}}function x(t,r,e){return t._getter=e.get,t._setter=e.set,t._parent=r,t._type=B,t}function O(t){nt=!0,t.forEach(function(t){return t.maybeReact()}),nt=!1}function T(t,r){var e=r.equals;return{_clone:function(){return t.atom(this._value)},withValidator:function(t){var r=this;if(null===t)return this._clone();if("function"!=typeof t)throw Error(".withValidator expects function or null");var e=function(){var e=r._clone(),n=r._validator;return e._validator=n?function(r){return t(r)&&n(r)}:t,{v:e}}();return"object"==typeof e?e.v:void 0},validate:function(){this._validate(this.get())},_validate:function(t){var r=this._validator&&this._validator(t);if(this._validator&&r!==!0)throw Error("Failed validation with value: '"+t+"'."+(" Validator returned '"+r+"' "))},set:function(t){if(nt)throw Error("Trying to set atom state during reaction phase. This is an error. Use middleware for cascading changes.");
if(this._validate(t),!e(t,this._value))if(this._state=q,it.inTransaction())it.currentTransaction().setState(this,t);else{this._value=t;var r=[];v(this,r),O(r),y(this)}return this},_get:function(){return it.inTransaction()?it.currentTransaction().getState(this):this._value}}}function j(t,r){return t._uid=Symbol("my_uid"),t._children=new M,t._state=N,t._value=r,t._type=I,t}function E(t){it.transact(new ot,t)}function A(){function t(t){for(var r=arguments.length,e=Array(r>1?r-1:0),i=1;r>i;i++)e[i-1]=arguments[i];return n.derive(function(){for(var r="",i=0;t.length>i;i++)r+=t[i],e.length>i&&(r+=n.unpack(e[i]));return r})}function r(t){if(n.isDerivable(t))return t.get();if(t instanceof Array)return t.map(r);if(t.constructor===Object){var e={},i=!0,a=!1,o=void 0;try{for(var u,s=Object.keys(t)[Symbol.iterator]();!(i=(u=s.next()).done);i=!0){var c=u.value;e[c]=r(t[c])}}catch(l){a=!0,o=l}finally{try{!i&&s["return"]&&s["return"]()}finally{if(a)throw o}}return e}return t}var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];e=u({},ut,e);var n={transact:E,Reaction:rt,isAtom:function(t){return t&&(t._type===I||t._type===B)},isDerivable:function(t){return t&&(t._type===I||t._type===B||t._type===z)},isDerivation:function(t){return t&&(t._type===z||t._type===B)},isLensed:function(t){return t&&t._type===B},isReaction:function(t){return t&&t._type===G}},i=m(n,e),a=k(n,e),o=u({},a,i,T(n,e)),s=u({},i,g(n,e)),c=u({},a,s,S(n,e));return n.atom=function(t){return j(Object.create(o),t)},n.swap=function(t,r,e){return t.set(r.apply(null,[t.get()].concat(e))).get()},n.derive=function(r,e,i,a,o){if(r instanceof Array)return t.apply(null,arguments);var u=arguments.length;switch(u){case 0:throw Error("Wrong arity for derive. Expecting 1+ args");case 1:return w(Object.create(s),r);case 2:return n.derive(function(){return e(r.get())});case 3:return n.derive(function(){return i(r.get(),e.get())});case 4:return n.derive(function(){return a(r.get(),e.get(),i.get())});case 5:return n.derive(function(){return o(r.get(),e.get(),i.get(),a.get());
});default:var c=Array.prototype.slice.call(arguments,0,u-1),l=arguments[u-1];return n.derive(function(){return l.apply(null,c.map(function(t){return t.get()}))})}},n.lens=function(t,r){var e=Object.create(c);return x(w(e,function(){return r.get(t.get())}),t,r)},n.unpack=function(t){return n.isDerivable(t)?t.get():t},n.lift=function(t){return function(){var r=arguments;return n.derive(function(){return t.apply(this,Array.prototype.map.call(r,n.unpack))})}},n.set=function(t,r){return t.set(r)},n.get=function(t){return t.get()},n.struct=function(t){return n.derive(function(){return r(t)})},n.ifThenElse=function(t,r,e){return t.then(r,e)},n.or=function(){for(var t=arguments.length,r=Array(t),e=0;t>e;e++)r[e]=arguments[e];return n.derive(function(){var t=void 0,e=!0,i=!1,a=void 0;try{for(var o,u=r[Symbol.iterator]();!(e=(o=u.next()).done);e=!0){var s=o.value;if(t=n.unpack(s))break}}catch(c){i=!0,a=c}finally{try{!e&&u["return"]&&u["return"]()}finally{if(i)throw a}}return t})},n.and=function(){for(var t=arguments.length,r=Array(t),e=0;t>e;e++)r[e]=arguments[e];return n.derive(function(){var t=void 0,e=!0,i=!1,a=void 0;try{for(var o,u=r[Symbol.iterator]();!(e=(o=u.next()).done);e=!0){var s=o.value;if(t=n.unpack(s),!t)break}}catch(c){i=!0,a=c}finally{try{!e&&u["return"]&&u["return"]()}finally{if(i)throw a}}return t})},n.not=function(t){return t.not()},n.switchCase=function(t){for(var r=arguments.length,e=Array(r>1?r-1:0),n=1;r>n;n++)e[n-1]=arguments[n];return i["switch"].apply(t,e)},n}var V=0,q=1,P=2,R=3,C=4,N=5,D=6,I=Symbol("ATOM"),z=Symbol("DERIVATION"),B=Symbol("LENS"),G=Symbol("REACTION"),Q=16,U=8,F=function(){function t(r){e(this,t),this._map={},this._size=0;var n=!0,i=!1,a=void 0;try{for(var o,u=r[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value;this.add(s)}}catch(c){i=!0,a=c}finally{try{!n&&u["return"]&&u["return"]()}finally{if(i)throw a}}}return a(t,[{key:"add",value:function(t){return this._map[t._id]=t,this._size++,this}},{key:"remove",value:function(t){return delete this._map[t._id],--this._size<=U?new L(s(this._map)):this;
}},{key:Symbol.iterator,value:function(){var t=Object.keys(this._map),r=Array(t.length),e=!0,n=!1,i=void 0;try{for(var a,o=t[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var u=a.value;r.push(this._map[u])}}catch(s){n=!0,i=s}finally{try{!e&&o["return"]&&o["return"]()}finally{if(n)throw i}}return r[Symbol.iterator]()}}]),t}(),L=function(){function t(r){e(this,t),this._array=r||[]}return a(t,[{key:"add",value:function(t){return this._array.indexOf(t)<0?(this._array.push(t),this.length===Q?new F(this._array):this):this}},{key:"remove",value:function(t){var r=this._array.indexOf(t);return r>=0&&(r===this._array.length-1?this._array.pop():this._array[r]=this._array.pop()),this}},{key:Symbol.iterator,value:function(){return this._array.slice(0)[Symbol.iterator]()}}]),t}(),M=function(){function t(){e(this,t),this._set=new L}return a(t,[{key:"add",value:function(t){this._set=this._set.add(t)}},{key:"remove",value:function(t){this._set=this._set.remove(t)}},{key:Symbol.iterator,value:function(){return this._set[Symbol.iterator]()}}]),t}(),W=[],H=Symbol("running"),J=Symbol("completed"),K=Symbol("aborted"),X=Symbol("parent_txn"),Y=Symbol("txn_value"),Z=Symbol("abort that junk yo"),$=function(){function t(){e(this,t),this.currentTxn=null}return a(t,[{key:"inTransaction",value:function(){return null!==this.currentTxn}},{key:"currentTransaction",value:function(){return this.currentTxn}},{key:"_begin",value:function(t){t[X]=this.currentTxn,t[Y]=H,this.currentTxn=t}},{key:"_popTransaction",value:function(t,r){var e=this.currentTxn;if(this.currentTxn=e[X],e[Y]!==H)throw Error("Must be in state 'RUNNING' to "+t+" transaction."+(" Was in state "+e[Y]+"."));r(e)}},{key:"_commit",value:function(){this._popTransaction("commit",function(t){t[Y]=J,t.onCommit&&t.onCommit()})}},{key:"_abort",value:function(){this._popTransaction("abort",function(t){t[Y]=K,t.onAbort&&t.onAbort()})}},{key:"transact",value:function(t,r){this._begin(t);try{r(p),this._commit()}catch(e){if(this._abort(),e!==Z)throw e}}}]),t}(),tt=function(){function t(r,n){e(this,t),
this.control=n,this.parent=r,this._state=N,this._uid=Symbol("my_uid"),this.active=!1,this._type=G}return a(t,[{key:"stop",value:function(){this.parent._children.remove(this),this.active=!1,this.control.onStop&&this.control.onStop()}},{key:"start",value:function(){this.parent._children.add(this),this.active=!0,this.control.onStart&&this.control.onStart(),this.parent._get()}},{key:"maybeReact",value:function(){if(this._state===C)switch((this.parent._state===C||this.parent._state===R||this.parent._state===D||this.parent._state===V)&&this.parent._get(),this.parent._state){case P:this._state=N;break;case q:this.force();break;default:throw Error("invalid mode for parent: "+this.parent._state)}}},{key:"force",value:function(){if(!this.control.react)throw Error("No reaction function available.");this._state=N,this.control.react(this.parent._get())}}]),t}(),rt=function(){function t(){e(this,t),this._type=G}return a(t,[{key:"_createBase",value:function(t){if(this._base)throw Error("This reaction has already been initialized");return this._base=new tt(t,this),this}},{key:"start",value:function(){return this._base.start(),this}},{key:"stop",value:function(){return this._base.stop(),this}},{key:"force",value:function(){return this._base.force(),this}},{key:"isRunning",value:function(){return this._base.active}}]),t}(),et=function(t){function n(t){e(this,n),i(Object.getPrototypeOf(n.prototype),"constructor",this).call(this),this.react=t}return r(n,t),n}(rt),nt=!1,it=new $,at={push:function(){}},ot=function(){function t(){e(this,t),this.inTxnValues={},this.reactionQueue=[]}return a(t,[{key:"getState",value:function(t){var r=this.inTxnValues[t._uid];return r?r[1]:t._value}},{key:"setState",value:function(t,r){this.inTxnValues[t._uid]=[t,r],v(t,this.reactionQueue)}},{key:"onCommit",value:function(){if(it.inTransaction()){var t=!0,r=!1,e=void 0;try{for(var i,a=s(this.inTxnValues)[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=n(i.value,2),u=o[0],c=o[1];u.set(c)}}catch(l){r=!0,e=l}finally{try{!t&&a["return"]&&a["return"]()}finally{
if(r)throw e}}}else{var f=!0,h=!1,_=void 0;try{for(var d,p=s(this.inTxnValues)[Symbol.iterator]();!(f=(d=p.next()).done);f=!0){var b=n(d.value,2),u=b[0],c=b[1];u._value=c,v(u,at)}}catch(l){h=!0,_=l}finally{try{!f&&p["return"]&&p["return"]()}finally{if(h)throw _}}O(this.reactionQueue);var m=!0,g=!1,w=void 0;try{for(var k,S=s(this.inTxnValues)[Symbol.iterator]();!(m=(k=S.next()).done);m=!0){var x=n(k.value,1),u=x[0];y(u)}}catch(l){g=!0,w=l}finally{try{!m&&S["return"]&&S["return"]()}finally{if(g)throw w}}}}},{key:"onAbort",value:function(){if(!it.inTransaction()){var t=!0,r=!1,e=void 0;try{for(var i,a=s(this.inTxnValues)[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=n(i.value,1),u=o[0];y(u)}}catch(c){r=!0,e=c}finally{try{!t&&a["return"]&&a["return"]()}finally{if(r)throw e}}}}}]),t}(),ut={equals:h};u(o,A()),o.withEquality=function(t){return A({equals:t})},o["default"]=o});