/**
 *  Copyright (c) 2015, David Sheldrick.
 *  All rights reserved.
 *
 *  This source code is licensed under the BSD-style license found in the
 *  LICENSE file in the root directory of this source tree.
 */
"use strict";function t(t,r,e){return r in t?Object.defineProperty(t,r,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[r]=e,t}function r(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),r&&(t.__proto__=r)}function e(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}var n=function(){function t(t,r){var e=[],n=!0,i=!1,a=void 0;try{for(var o,u=t[Symbol.iterator]();!(n=(o=u.next()).done)&&(e.push(o.value),!r||e.length!==r);n=!0);}catch(s){i=!0,a=s}finally{try{!n&&u["return"]&&u["return"]()}finally{if(i)throw a}}return e}return function(r,e){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return t(r,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i=function o(t,r,e){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,r);if(void 0===n){var i=Object.getPrototypeOf(t);return null===i?void 0:o(i,r,e)}if("value"in n)return n.value;var a=n.get;return void 0===a?void 0:a.call(e)},a=function(){function t(t,r){for(var e=0;r.length>e;e++){var n=r[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(r,e,n){return e&&t(r.prototype,e),n&&t(r,n),r}}();!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(t.Havelock={})}(void 0,function(o){function u(t,r){if(t._type===I)r.push(t);else{var e=!0,n=!1,i=void 0;try{for(var a,o=t._children[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value;s._state!==R&&(s._state=R,u(s,r))}}catch(c){n=!0,i=c}finally{try{!e&&o["return"]&&o["return"]()}finally{if(n)throw i}}}}function s(t){switch(t._state){case A:case E:var r=!0,e=!1,n=void 0;try{for(var i,a=t._children[Symbol.iterator]();!(r=(i=a.next()).done);r=!0){var o=i.value;s(o)}}catch(u){
e=!0,n=u}finally{try{!r&&a["return"]&&a["return"]()}finally{if(e)throw n}}t._state=V;break;case R:var c=[],l=!0,f=!1,h=void 0;try{for(var v,y=t._parents[Symbol.iterator]();!(l=(v=y.next()).done);l=!0){var d=v.value;d._state===A&&(t._state=j),d._children.remove(t),c.push([d,d._value])}}catch(u){f=!0,h=u}finally{try{!l&&y["return"]&&y["return"]()}finally{if(f)throw h}}t._state!==j&&(t._state=D,t._parents=c);break;case V:break;default:throw Error("It should be impossible tosweep nodes with mode: "+t._state)}}function c(){throw Q}function l(t){var r=!0,e=!1,n=void 0;try{for(var i=arguments.length,a=Array(i>1?i-1:0),o=1;i>o;o++)a[o-1]=arguments[o];for(var u,s=a[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){var c=u.value,l=!0,f=!1,h=void 0;try{for(var v,y=Object.keys(c)[Symbol.iterator]();!(l=(v=y.next()).done);l=!0){var d=v.value;t[d]=c[d]}}catch(_){f=!0,h=_}finally{try{!l&&y["return"]&&y["return"]()}finally{if(f)throw h}}}}catch(_){e=!0,n=_}finally{try{!r&&s["return"]&&s["return"]()}finally{if(e)throw n}}return t}function f(t){return Object.getOwnPropertySymbols(t).map(function(r){return t[r]})}function h(t){K=!0,t.forEach(function(t){return t.maybeReact()}),K=!1}function v(t,r){var e=r.equals;return{_clone:function(){return t.atom(this._value)},withValidator:function(t){var r=this;if(null===t)return this._clone();if("function"!=typeof t)throw Error(".withValidator expects function or null");var e=function(){var e=r._clone(),n=r._validator;return e._validator=n?function(r){return t(r)&&n(r)}:t,{v:e}}();return"object"==typeof e?e.v:void 0},validate:function(){this._validate(this.get())},_validate:function(t){var r=this._validator&&this._validator(t);if(this._validator&&r!==!0)throw Error("Failed validation with value: '"+t+"'."+(" Validator returned '"+r+"' "))},set:function(t){if(K)throw Error("Trying to set atom state during reaction phase. This is an error. Use middleware for cascading changes.");if(this._validate(t),!e(t,this._value))if(this._state=A,X.inTransaction())X.currentTransaction().setState(this,t);else{
this._value=t;var r=[];u(this,r),h(r),s(this)}return t},_get:function(){return X.inTransaction()?X.currentTransaction().getState(this):this._value}}}function y(t,r){return t._uid=Symbol("my_uid"),t._children=new J,t._state=V,t._value=r,t._type=q,t}function d(t){return Z.push(new J),t(),Z.pop()}function _(t){Z.length>0&&Z[Z.length-1].add(t)}function p(t,r){var e=r.equals;return{_clone:function(){return t.derive(this._deriver)},_forceGet:function(){var t=this,r=d(function(){var r=t._deriver();t._state=e(r,t._value)?E:A,t._value=r}),n=!0,i=!1,a=void 0;try{for(var o,u=this._parents[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value;r[s._uid]||s._children.remove(this)}}catch(c){i=!0,a=c}finally{try{!n&&u["return"]&&u["return"]()}finally{if(i)throw a}}this._parents=r;var l=!0,f=!1,h=void 0;try{for(var v,y=r[Symbol.iterator]();!(l=(v=y.next()).done);l=!0){var _=v.value;_._children.add(this)}}catch(c){f=!0,h=c}finally{try{!l&&y["return"]&&y["return"]()}finally{if(f)throw h}}},_get:function(){t:switch(this._state){case O:case j:this._forceGet();break;case R:var t=!0,r=!1,i=void 0;try{for(var a,o=this._parents[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var u=a.value;switch((u._state===R||u._state===j||u._state===D)&&u._get(),u._state){case V:case E:break;case A:this._forceGet();break t;default:throw Error("invalid parent mode: "+u._state)}}}catch(s){r=!0,i=s}finally{try{!t&&o["return"]&&o["return"]()}finally{if(r)throw i}}this._state=E;break;case D:var c=new J,l=!0,f=!1,h=void 0;try{for(var v,y=this._parents[Symbol.iterator]();!(l=(v=y.next()).done);l=!0){var d=n(v.value,2),_=d[0],p=d[1];if(!e(_._get(),p)){this._forceGet();break t}c.add(_)}}catch(s){f=!0,h=s}finally{try{!l&&y["return"]&&y["return"]()}finally{if(f)throw h}}this._parents=c,this._state=E}return this._value}}}function m(t,r){return t._uid=Symbol("my_uid"),t._children=new J,t._parents=new J,t._deriver=r,t._state=O,t._type=C,t._value=Symbol("null"),t}function b(t){return{_clone:function(){return t.lens(this._parent,{get:this._getter,set:this._setter
})},set:function(t){return this._parent.set(this._setter(this._parent._get(),t)),this.get()}}}function g(t,r,e){return t._getter=e.get,t._setter=e.set,t._parent=r,t._type=N,t}function w(t){return l(new tt,t)}function k(r,e){var n=e.equals;return t({derive:function(t){return r.derive(this,t)},reaction:function(t){if("function"==typeof t)return new rt(t)._createBase(this);if(t instanceof tt)return t._createBase(this);if(t&&t.react)return w(t)._createBase(this);throw Error("Unrecognized type for reaction "+t)},react:function(t){return this.reaction(t).start().force()},get:function(){return _(this),this._get()},is:function(t){return r.lift(n)(this,t)},and:function(t){return this.derive(function(e){return e&&r.unpack(t)})},or:function(t){return this.derive(function(e){return e||r.unpack(t)})},then:function(t,e){return this.derive(function(n){return r.unpack(n?t:e)})},not:function(){return this.derive(function(t){return!t})}},"switch",function(){for(var t=arguments.length,e=Array(t),i=0;t>i;i++)e[i]=arguments[i];return this.derive(function(t){var i=void 0;for(i=0;e.length-1>i;i+=2)if(n(t,r.unpack(e[i])))return r.unpack(e[i+1]);return i===e.length-1?r.unpack(e[i]):void 0})})}function S(t){return{swap:function(t){for(var r=arguments.length,e=Array(r>1?r-1:0),n=1;r>n;n++)e[n-1]=arguments[n];return this.set(t.apply(null,[this.get()].concat(e)))},lens:function(r){return t.lens(this,r)}}}function x(){function t(t){for(var r=arguments.length,e=Array(r>1?r-1:0),i=1;r>i;i++)e[i-1]=arguments[i];return n.derive(function(){for(var r="",i=0;t.length>i;i++)r+=t[i],e.length>i&&(r+=n.unpack(e[i]));return r})}function r(t){if(n.isDerivable(t))return t.get();if(t instanceof Array)return t.map(r);if(t.constructor===Object){var e={},i=!0,a=!1,o=void 0;try{for(var u,s=Object.keys(t)[Symbol.iterator]();!(i=(u=s.next()).done);i=!0){var c=u.value;e[c]=r(t[c])}}catch(l){a=!0,o=l}finally{try{!i&&s["return"]&&s["return"]()}finally{if(a)throw o}}return e}return t}var e=void 0===arguments[0]?{}:arguments[0];e=l({},et,e);var n={transact:at,Reaction:tt,
isAtom:function(t){return t&&t._type===q},isDerivation:function(t){return t&&(t._type===C||t._type===N)},isLens:function(t){return t&&t._type===N},isReaction:function(t){return t&&t._type===I}};n.isDerivable=function(t){return n.isDerivation(t)||n.isAtom(t)};var i=k(n,e),a=S(n,e),o=l({},a,i,v(n,e)),u=l({},i,p(n,e)),s=l({},a,u,b(n,e));return n.atom=function(t){return y(Object.create(o),t)},n.swap=function(t,r,e){return t.set(r.apply(null,[t.get()].concat(e)))},n.derive=function(r,e,i,a,o){if(r instanceof Array)return t.apply(null,arguments);var s=arguments.length;switch(s){case 0:throw Error("Wrong arity for derive. Expecting 1+ args");case 1:return m(Object.create(u),r);case 2:return n.derive(function(){return e(r.get())});case 3:return n.derive(function(){return i(r.get(),e.get())});case 4:return n.derive(function(){return a(r.get(),e.get(),i.get())});case 5:return n.derive(function(){return o(r.get(),e.get(),i.get(),a.get())});default:var c=Array.prototype.slice.call(arguments,0,s-1),l=arguments[s-1];return n.derive(function(){return l.apply(null,c.map(function(t){return t.get()}))})}},n.lens=function(t,r){var e=Object.create(s);return g(m(e,function(){return r.get(t.get())}),t,r)},n.unpack=function(t){return n.isDerivable(t)?t.get():t},n.lift=function(t){return function(){var r=arguments;return n.derive(function(){return t.apply(this,Array.prototype.map.call(r,n.unpack))})}},n.set=function(t,r){return t.set(r)},n.get=function(t){return t.get()},n.struct=function(t){return n.derive(function(){return r(t)})},n.ifThenElse=function(t,r,e){return t.then(r,e)},n.or=function(){for(var t=arguments.length,r=Array(t),e=0;t>e;e++)r[e]=arguments[e];return n.derive(function(){var t=void 0,e=!0,i=!1,a=void 0;try{for(var o,u=r[Symbol.iterator]();!(e=(o=u.next()).done);e=!0){var s=o.value;if(t=n.unpack(s))break}}catch(c){i=!0,a=c}finally{try{!e&&u["return"]&&u["return"]()}finally{if(i)throw a}}return t})},n.and=function(){for(var t=arguments.length,r=Array(t),e=0;t>e;e++)r[e]=arguments[e];return n.derive(function(){var t=void 0,e=!0,i=!1,a=void 0;
try{for(var o,u=r[Symbol.iterator]();!(e=(o=u.next()).done);e=!0){var s=o.value;if(t=n.unpack(s),!t)break}}catch(c){i=!0,a=c}finally{try{!e&&u["return"]&&u["return"]()}finally{if(i)throw a}}return t})},n.not=function(t){return t.not()},n.switchCase=function(t){for(var r=arguments.length,e=Array(r>1?r-1:0),n=1;r>n;n++)e[n-1]=arguments[n];return i["switch"].apply(t,e)},n}function T(t){return x({equals:t})}var O=0,A=1,E=2,j=3,R=4,V=5,D=6,q=Symbol("ATOM"),C=Symbol("DERIVATION"),N=Symbol("LENS"),I=Symbol("REACTION"),P=Symbol("running"),z=Symbol("completed"),G=Symbol("aborted"),B=Symbol("parent_txn"),L=Symbol("txn_value"),Q=Symbol("abort that junk yo"),U=function(){function t(){e(this,t),this.currentTxn=null}return a(t,[{key:"inTransaction",value:function(){return null!==this.currentTxn}},{key:"currentTransaction",value:function(){return this.currentTxn}},{key:"_begin",value:function(t){t[B]=this.currentTxn,t[L]=P,this.currentTxn=t}},{key:"_popTransaction",value:function(t,r){var e=this.currentTxn;if(this.currentTxn=e[B],e[L]!==P)throw Error("Must be in state 'RUNNING' to "+t+" transaction."+(" Was in state "+e[L]+"."));r(e)}},{key:"_commit",value:function(){this._popTransaction("commit",function(t){t[L]=z,t.onCommit&&t.onCommit()})}},{key:"_abort",value:function(){this._popTransaction("abort",function(t){t[L]=G,t.onAbort&&t.onAbort()})}},{key:"transact",value:function(t,r){this._begin(t);try{r(c),this._commit()}catch(e){if(this._abort(),e!==Q)throw e}}}]),t}(),F=16,M=8,W=function(){function t(r){e(this,t),this._map={},this._size=0;var n=!0,i=!1,a=void 0;try{for(var o,u=r[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value;this.add(s)}}catch(c){i=!0,a=c}finally{try{!n&&u["return"]&&u["return"]()}finally{if(i)throw a}}}return a(t,[{key:"add",value:function(t){return this._map[t._id]=t,this._size++,this}},{key:"remove",value:function(t){return delete this._map[t._id],--this._size<=M?new H(f(this._map)):this}},{key:Symbol.iterator,value:regeneratorRuntime.mark(function r(){var t,e,n,i,a,o;return regeneratorRuntime.wrap(function(r){
for(;;)switch(r.prev=r.next){case 0:t=!0,e=!1,n=void 0,r.prev=3,i=this._map[Symbol.iterator]();case 5:if(t=(a=i.next()).done){r.next=12;break}return o=a.value,r.next=9,this._map[o];case 9:t=!0,r.next=5;break;case 12:r.next=18;break;case 14:r.prev=14,r.t0=r["catch"](3),e=!0,n=r.t0;case 18:r.prev=18,r.prev=19,!t&&i["return"]&&i["return"]();case 21:if(r.prev=21,!e){r.next=24;break}throw n;case 24:return r.finish(21);case 25:return r.finish(18);case 26:case"end":return r.stop()}},r,this,[[3,14,18,26],[19,,21,25]])})}]),t}(),H=function(){function t(r){e(this,t),this._array=r||[]}return a(t,[{key:"add",value:function(t){return this._array.indexOf(t)<0?(this._array.push(t),this.length===F?new W(this._array):this):this}},{key:"remove",value:function(t){var r=this._array.indexOf(t);return r>=0&&(r===this._array.length-1?this._array.pop():this._array[r]=this._array.pop()),this}},{key:Symbol.iterator,value:function(){return this._array.slice(0)[Symbol.iterator]()}}]),t}(),J=function(){function t(){e(this,t),this._set=new H}return a(t,[{key:"add",value:function(t){this._set=this._set.add(t)}},{key:"remove",value:function(t){this._set=this._set.remove(t)}},{key:Symbol.iterator,value:function(){return this._set[Symbol.iterator]()}}]),t}(),K=!1,X=new U,Y={push:function(){}},Z=(function(){function t(){e(this,t),this.inTxnValues={},this.reactionQueue=[]}return a(t,[{key:"getState",value:function(t){var r=this.inTxnValues[t._uid];return r?r[1]:t._value}},{key:"setState",value:function(t,r){this.inTxnValues[t._uid]=[t,r],u(t,this.reactionQueue)}},{key:"onCommit",value:function(){if(X.inTransaction()){var t=!0,r=!1,e=void 0;try{for(var i,a=f(this.inTxnValues)[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=n(i.value,2),c=o[0],l=o[1];c.set(l)}}catch(v){r=!0,e=v}finally{try{!t&&a["return"]&&a["return"]()}finally{if(r)throw e}}}else{var y=!0,d=!1,_=void 0;try{for(var p,m=f(this.inTxnValues)[Symbol.iterator]();!(y=(p=m.next()).done);y=!0){var b=n(p.value,2),g=b[0],l=b[1];g._value=l,u(g,Y)}}catch(v){d=!0,_=v}finally{try{!y&&m["return"]&&m["return"]();
}finally{if(d)throw _}}h(this.reactionQueue);var w=!0,k=!1,S=void 0;try{for(var x,T=f(this.inTxnValues)[Symbol.iterator]();!(w=(x=T.next()).done);w=!0){var O=n(x.value,1),A=O[0];s(A)}}catch(v){k=!0,S=v}finally{try{!w&&T["return"]&&T["return"]()}finally{if(k)throw S}}}}},{key:"onAbort",value:function(){if(!X.inTransaction()){var t=!0,r=!1,e=void 0;try{for(var i,a=f(this.inTxnValues)[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=n(i.value,1),u=o[0];s(u)}}catch(c){r=!0,e=c}finally{try{!t&&a["return"]&&a["return"]()}finally{if(r)throw e}}}}}]),t}(),[]),$=function(){function t(r,n){e(this,t),this.control=n,this.parent=r,this._state=V,this._uid=Symbol("my_uid"),this.active=!1,this._type=I}return a(t,[{key:"stop",value:function(){this.parent._children.remove(this),this.active=!1,this.control.onStop&&this.control.onStop()}},{key:"start",value:function(){this.parent._children.add(this),this.active=!0,this.control.onStart&&this.control.onStart(),this.parent._get()}},{key:"maybeReact",value:function(){if(this._state===R)switch((this.parent._state===R||this.parent._state===j||this.parent._state===D||this.parent._state===O)&&this.parent._get(),this.parent._state){case E:this._state=V;break;case A:this.force();break;default:throw Error("invalid mode for parent: "+this.parent._state)}}},{key:"force",value:function(){if(!this.control.react)throw Error("No reaction function available.");this._state=V,this.control.react(this.parent._get())}}]),t}(),tt=function(){function t(){e(this,t),this._type=I}return a(t,[{key:"_createBase",value:function(t){if(this._base)throw Error("This reaction has already been initialized");return this._base=new $(t,this),this}},{key:"start",value:function(){return this._base.start(),this}},{key:"stop",value:function(){return this._base.stop(),this}},{key:"force",value:function(){return this._base.force(),this}},{key:"isRunning",value:function(){return this._base.active}}]),t}(),rt=function(t){function n(t){e(this,n),i(Object.getPrototypeOf(n.prototype),"constructor",this).call(this),this.react=t}return r(n,t),
n}(tt),et={equals:equals},nt=x(),it=nt.Reaction,at=nt.transact,ot=nt;o.withEquality=T,o.r=it,o.isAtom=void 0,o.isDerivation=void 0,o.isLens=void 0,o.isReaction=void 0,o.isDerivable=void 0,o.transact=void 0,o.atom=void 0,o.swap=void 0,o.derive=void 0,o.lens=void 0,o.unpack=void 0,o.lift=void 0,o.set=void 0,o.get=void 0,o.struct=void 0,o.ifThenElse=void 0,o.or=void 0,o.and=void 0,o.not=void 0,o.switchCase=void 0,o["default"]=ot});