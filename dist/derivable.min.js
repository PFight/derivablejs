"use strict";function t(t){for(var n=1;arguments.length>n;n++)for(var e=arguments[n],r=S(e||{}),i=r.length;i--;){var o=r[i];t[o]=e[o]}return t}function n(t,n){return t===n?0!==t||1/t===1/n:t!==t&&n!==n}function e(t,e){return n(t,e)||t&&"function"==typeof t.equals&&t.equals(e)}function r(t,n){var e=t.indexOf(n);0>e&&t.push(n)}function i(t,n){var e=t.indexOf(n);e>=0&&t.splice(e,1)}function o(){return T++}function u(t,n){return Array.prototype.slice.call(t,n)}function a(t){return null!==t&&void 0!==t}function c(t){F=!!t}function s(t,n){return t._equals=n,t}function h(){throw N}function l(t){this.parent=t,this.id2txnAtom={},this.globalEpoch=G.globalEpoch,this.modifiedAtoms=[]}function f(){return null!==U}function _(t){v();try{t.call(null,h)}catch(n){if(g(),n!==N)throw n;return}d()}function p(t){return function(){var n,e=u(arguments,0),r=this;return _(function(){n=t.apply(r,e)}),n}}function v(){U=new l(U)}function d(){var t=U;U=t.parent;var n=[],e=0;t.modifiedAtoms.forEach(function(r){null!==U?r.set(t.id2txnAtom[r._id]._value):(r._set(t.id2txnAtom[r._id]._value),e=y(r._activeChildren,n,e))}),null===U?G.globalEpoch=t.globalEpoch:U.globalEpoch=t.globalEpoch,n.forEach(function(t){t._maybeReact()})}function g(){var t=U;U=t.parent,null===U?G.globalEpoch=t.globalEpoch+1:U.globalEpoch=t.globalEpoch+1}function y(t,n,e){for(var r=0,i=t.length;i>r;r++){var o=t[r];o._type===M?n[e++]=o:e=y(o._activeChildren,n,e)}return e}function E(){0===H&&v(),H++;var t=!1;return{tick:function(){if(t)throw new Error("trying to use ticker after release");d(),v()},reset:function(){if(t)throw new Error("trying to use ticker after release");g(),v()},release:function(){if(t)throw new Error("ticker already released");H--,t=!0,0===H&&d()}}}function b(t){var n=J.length;J.push([]);try{return t(),J[n]}finally{J.pop()}}function m(t){if(J.length>0){var n=J[J.length-1];return n.push(t,0),n.length-1}return-1}function w(t,n){J.length>0&&(J[J.length-1][t]=n)}function k(t,n){return{_clone:function(){return s(t.atom(this._value),this._equals)},set:function(t){if(null!==U){
var n=U.id2txnAtom[this._id];if(null!=n)this.__equals(t,n._value)||(n._epoch++,U.globalEpoch++),n._value=t;else{for(var e=U.parent;null!==e;){if(n=e.id2txnAtom[this._id],void 0!==n){if(!this.__equals(n._value,t)){var i=n._clone();i._id=this._id,i._value=t,i._epoch=n._epoch+1,U.globalEpoch++,U.id2txnAtom[this._id]=i,r(U.modifiedAtoms,this)}return}e=e.parent}U.globalEpoch++,n=this._clone(),n._value=t,n._id=this._id,n._epoch=this._epoch+1,U.id2txnAtom[this._id]=n,r(U.modifiedAtoms,this)}}else if(!this.__equals(t,this._value)){this._set(t),this._reactorBuffer.length=y(this._activeChildren,this._reactorBuffer,0);for(var o=0,u=this._reactorBuffer.length;u>o;o++){var a=this._reactorBuffer[o];if(a._reacting)throw this._reactorBuffer.length=0,new Error("cyclical update detected");a._maybeReact()}this._reactorBuffer.length=0}},_set:function(t){G.globalEpoch++,this._epoch++,this._value=t},get:function(){for(var t,n=U;null!==n;){if(t=n.id2txnAtom[this._id],void 0!==t)return w(m(this),t._epoch),t._value;n=n.parent}return w(m(this),this._epoch),this._value},_getEpoch:function(){for(var t,n=U;null!==n;){if(t=n.id2txnAtom[this._id],void 0!==t)return t._epoch;n=n.parent}return this._epoch},_unlisten:function(){},_listen:function(){}}}function A(t,n){return t._id=o(),t._activeChildren=[],t._reactorBuffer=[],t._epoch=0,t._value=n,t._type=z,t._equals=null,t._atoms=[t],t}function q(t,n){this._derivable=n,t&&(this.react=t),this._parent=null,this._active=!1,this._yielding=!1,this._reacting=!1,this._type=M,F&&(this.stack=Error().stack)}function x(t,n){var e={derive:function(n,e,r,i,o){var a=this;switch(arguments.length){case 0:throw new Error(".derive takes at least one argument");case 1:switch(typeof n){case"function":return t.derivation(function(){return n(a.get())});case"string":case"number":return t.derivation(function(){return a.get()[t.unpack(n)]});default:if(n instanceof Array)return n.map(function(t){return a.derive(t)});if(n instanceof RegExp)return t.derivation(function(){return a.get().match(n)});if(t.isDerivable(n))return t.derivation(function(){
var t=n.get(),e=a.get();switch(typeof t){case"function":return t(e);case"string":case"number":return e[t];default:if(t instanceof RegExp)return e.match(t);throw Error("type error")}});throw Error("type error")}case 2:return t.derivation(function(){return n(a.get(),t.unpack(e))});case 3:return t.derivation(function(){return n(a.get(),t.unpack(e),t.unpack(r))});case 4:return t.derivation(function(){return n(a.get(),t.unpack(e),t.unpack(r),t.unpack(i))});case 5:return t.derivation(function(){return n(a.get(),t.unpack(e),t.unpack(r),t.unpack(i),t.unpack(o))});default:var c=[a].concat(u(arguments,1));return t.derivation(function(){return n.apply(null,c.map(t.unpack))})}},reactor:function(t){if("function"==typeof t)return new q(t,this);if(t instanceof q){if("function"!=typeof t.react)throw new Error("reactor missing .react method");return t._derivable=this,t}if(t&&t.react)return B(new q(null,this),t);throw new Error("Unrecognized type for reactor "+t)},react:function(n,e){function r(n,e){if(!t.isDerivable(n))if("function"==typeof n)n=t.derivation(n);else{if("boolean"!=typeof n)throw Error("react "+e+" condition must be derivable");n=t.atom(n)}return n}if("function"!=typeof n)throw Error("the first argument to .react must be a function");e=B({once:!1,from:!0,until:!1,when:!0,skipFirst:!1},e);var i=this.reactor({react:function(t){e.skipFirst?e.skipFirst=!1:(n(t),e.once&&(this.stop(),o.stop()))},onStart:e.onStart,onStop:e.onStop}),o=t.struct({until:r(e.until,"until"),when:r(e.when,"when")}).reactor(function(t){t.until?(i.stop(),this.stop()):t.when?i.isActive()||i.start().force():i.isActive()&&i.stop()});r(e.from,"from").reactor(function(t){t&&(o.start().force(),this.stop())}).start().force()},is:function(e){return t.lift(this._equals||n.equals)(this,e)},and:function(n){return this.derive(function(e){return e&&t.unpack(n)})},or:function(n){return this.derive(function(e){return e||t.unpack(n)})},then:function(n,e){return this.derive(function(r){return t.unpack(r?n:e)})},mThen:function(n,e){return this.derive(function(r){return t.unpack(a(r)?n:e);
})},mOr:function(t){return this.mThen(this,t)},mDerive:function(t){if(1===arguments.length&&t instanceof Array){var n=this;return t.map(function(t){return n.mDerive(t)})}return this.mThen(this.derive.apply(this,arguments))},mAnd:function(t){return this.mThen(t,this)},not:function(){return this.derive(function(t){return!t})},withEquality:function(t){if(t){if("function"!=typeof t)throw new Error("equals must be function")}else t=null;return s(this._clone(),t)},__equals:function(t,e){return(this._equals||n.equals)(t,e)}};return e["switch"]=function(){var e=arguments;return this.derive(function(r){var i;for(i=0;e.length-1>i;i+=2)if(n.equals(r,t.unpack(e[i])))return t.unpack(e[i+1]);return i===e.length-1?t.unpack(e[i]):void 0})},e}function C(t,n){return{_clone:function(){return s(t.derivation(this._deriver),this._equals)},_forceEval:function(){var t=this,n=null,e=b(function(){if(F)try{n=t._deriver()}catch(e){throw console.error(t.stack),e}else n=t._deriver()});if(this.__equals(n,this._value)||this._epoch++,this._refCount>0){for(var o=0,u=0,a=this._lastParentsEpochs.length,c=e.length;a>o&&c>u&&this._lastParentsEpochs[o]===e[u];)o+=2,u+=2;for(;a>o;)i(this._lastParentsEpochs[o]._activeChildren,this),this._lastParentsEpochs[o]._unlisten(),o+=2;for(;c>u;)r(e[u]._activeChildren,this),e[u]._listen(),u+=2}this._lastParentsEpochs=e,this._value=n},_update:function(){var t=null===U?G.globalEpoch:U.globalEpoch;if(this._lastGlobalEpoch!==t){if(this._value===V)this._forceEval();else for(var n=0,e=this._lastParentsEpochs.length;e>n;n+=2){var r,i=this._lastParentsEpochs[n],o=this._lastParentsEpochs[n+1];if(i._type===z?r=i._getEpoch():(i._update(),r=i._epoch),r!==o)return void this._forceEval()}this._lastGlobalEpoch=t}},get:function(){var t=m(this);return this._update(),w(t,this._epoch),this._value},_listen:function(){this._refCount++;for(var t=0,n=this._lastParentsEpochs.length;n>t;t+=2){var e=this._lastParentsEpochs[t];1===this._refCount&&r(e._activeChildren,this),e._listen()}},_unlisten:function(){this._refCount--;for(var t=0,n=this._lastParentsEpochs.length;n>t;t+=2){
var e=this._lastParentsEpochs[t];0===this._refCount&&i(e._activeChildren,this),e._unlisten()}}}}function O(t,n){return t._deriver=n,t._lastParentsEpochs=[],t._lastGlobalEpoch=G.globalEpoch-1,t._epoch=0,t._type=I,t._value=V,t._equals=null,t._activeChildren=[],t._refCount=0,F&&(t.stack=Error().stack),t}function D(t,n){return{swap:function(t){var n=u(arguments,0);return n[0]=this.get(),this.set(t.apply(null,n))},lens:function(n){var e=this;return t.lens({get:function(){return n.get(e.get())},set:function(t){e.set(n.set(e.get(),t))}})}}}function P(t,n){return{_clone:function(){return s(t.lens(this._lensDescriptor),this._equals)},set:function(n){var e=this;return t.atomically(function(){e._lensDescriptor.set(n)}),this}}}function R(t,n){return t._lensDescriptor=n,t._type=L,t}function j(t){function n(t){if(s.isDerivable(t))return t.get();if(t instanceof Array)return t.map(n);if(t.constructor===Object){for(var e={},r=S(t),i=r.length;i--;){var o=r[i];e[o]=n(t[o])}return e}return t}function r(t){return function(){var n=arguments;return s.derivation(function(){for(var e,r=0;n.length>r&&(e=s.unpack(n[r]),!t(e));r++);return e})}}function i(t){return t}function o(t){return function(n){return!t(n)}}t=B({},Q,t||{});var s={transact:_,defaultEquals:e,setDebugMode:c,transaction:p,ticker:E,Reactor:q,isAtom:function(t){return t&&(t._type===z||t._type===L)},isDerivable:function(t){return t&&(t._type===z||t._type===L||t._type===I)},isDerivation:function(t){return t&&(t._type===I||t._type===L)},isLensed:function(t){return t&&t._type===L},isReactor:function(t){return t&&t._type===M}},h=x(s,t),l=D(s,t),v=B({},l,h,k(s,t)),d=B({},h,C(s,t)),g=B({},l,d,P(s,t));return s.atom=function(t){return A(Object.create(v),t)},s.atomic=function(t){return function(){var n,e=this,r=arguments;return s.atomically(function(){n=t.apply(e,r)}),n}},s.atomically=function(t){f()?t():s.transact(t)},s.derivation=function(t){return O(Object.create(d),t)},s.derive=function(t){var n=u(arguments,1);return s.derivation(function(){for(var e="",r=0;t.length>r;r++)e+=t[r],n.length>r&&(e+=s.unpack(n[r]));
return e})},s.lens=function(t){return R(O(Object.create(g),t.get),t)},s.unpack=function(t){return s.isDerivable(t)?t.get():t},s.lift=function(t){return function(){var n=arguments,e=this;return s.derivation(function(){return t.apply(e,Array.prototype.map.call(n,s.unpack))})}},s.struct=function(t){if(t.constructor===Object||t instanceof Array)return s.derivation(function(){return n(t)});throw new Error("`struct` expects plain Object or Array")},s.or=r(i),s.mOr=r(a),s.and=r(o(i)),s.mAnd=r(o(a)),s}var S=Object.keys,B=Object.assign;B||(B=t);var T=0,V=Object.freeze({equals:function(){return!1}}),F=!1,G={globalEpoch:0},z="ATOM",I="DERIVATION",L="LENS",M="REACTOR",N={},U=null,H=0,J=[],K=[];B(q.prototype,{start:function(){this._lastValue=this._derivable.get(),this._lastEpoch=this._derivable._epoch,r(this._derivable._activeChildren,this),this._derivable._listen();var t=K.length;return t>0&&(this._parent=K[t-1]),this._active=!0,this.onStart&&this.onStart(),this},_force:function(t){try{K.push(this),this._reacting=!0,this.react(t)}catch(n){throw F&&console.error(this.stack),n}finally{this._reacting=!1,K.pop()}},force:function(){return this._force(this._derivable.get()),this},_maybeReact:function(){if(!this._reacting&&this._active){if(this._yielding)throw Error("reactor dependency cycle detected");if(null!==this._parent){this._yielding=!0;try{this._parent._maybeReact()}finally{this._yielding=!1}}if(this._active){var t=this._derivable.get();this._derivable._epoch===this._lastEpoch||this._derivable.__equals(t,this._lastValue)||this._force(t),this._lastEpoch=this._derivable._epoch,this._lastValue=t}}},stop:function(){return i(this._derivable._activeChildren,this),this._derivable._unlisten(),this._parent=null,this._active=!1,this.onStop&&this.onStop(),this},orphan:function(){return this._parent=null,this},adopt:function(t){return t._parent=this,this},isActive:function(){return this._active}});var Q={equals:e};B(exports,j()),exports.withEquality=function(t){return j({equals:t})},exports["default"]=exports;
//# sourceMappingURL=dist/derivable.min.js.map
//# sourceMappingURL=derivable.min.js.map