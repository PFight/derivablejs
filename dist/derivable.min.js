!function(t,n){"use strict";t&&"function"==typeof t.define&&t.define.amd?t.define(["exports"],n):n("undefined"!=typeof exports?exports:t.Derivable={})}(this,function(t){"use strict";function n(t){for(var n=1;arguments.length>n;n++)for(var r=arguments[n],e=V(r||{}),i=e.length;i--;){var o=e[i];t[o]=r[o]}return t}function r(t,n){return t===n?0!==t||1/t===1/n:t!==t&&n!==n}function e(t,n){return r(t,n)||t&&"function"==typeof t.equals&&t.equals(n)}function i(t,n){var r=t.indexOf(n);0>r&&t.push(n)}function o(t,n){var r=t.indexOf(n);r>=0&&t.splice(r,1)}function u(){return G++}function c(t,n){return Array.prototype.slice.call(t,n)}function a(t){return null!==t&&void 0!==t}function s(t){N=!!t}function h(t,n){return t._equals=n,t}function f(){throw L}function l(t){this.parent=t,this.id2txnAtom={},this.globalEpoch=z.globalEpoch,this.modifiedAtoms=[]}function p(){return null!==M}function _(t){v();try{t.call(null,f)}catch(n){if(g(),n!==L)throw n;return}d()}function v(){M=new l(M)}function d(){var t=M;M=t.parent;var n=[];t.modifiedAtoms.forEach(function(r){null!==M?r.set(t.id2txnAtom[r._id]._value):(r._set(t.id2txnAtom[r._id]._value),n.push(r._reactors))}),null===M?z.globalEpoch=t.globalEpoch:M.globalEpoch=t.globalEpoch,n.forEach(function(t){t.forEach(function(t){t._maybeReact()})})}function g(){var t=M;M=t.parent,null===M?z.globalEpoch=t.globalEpoch+1:M.globalEpoch=t.globalEpoch+1}function y(){v();var t=!1;return{tick:function(){if(t)throw new Error("can't tick disposed ticker");d(),v()},stop:function(){if(t)throw new Error("ticker already disposed");t=!0,d()},resetState:function(){if(t)throw new Error("ticker already disposed");g(),v()}}}function E(t){var n=U.length;U.push([]);try{return t(),U[n]}finally{U.pop()}}function m(t){if(U.length>0){var n=U[U.length-1];return n.push(t,0),n.length-1}return-1}function b(t,n){U.length>0&&(U[U.length-1][t]=n)}function k(t,n){return{_clone:function(){return h(t.atom(this._value),this._equals)},set:function(t){if(null!==M){var n=void 0;void 0!==(n=M.id2txnAtom[this._id])&&t!==n._value?(M.globalEpoch++,
n._epoch++,n._value=t):this.__equals(t,this._value)||(M.globalEpoch++,n=this._clone(),n._value=t,n._id=this._id,n._epoch=this._epoch+1,M.id2txnAtom[this._id]=n,i(M.modifiedAtoms,this))}else this.__equals(t,this._value)||(this._set(t),this._reactors.forEach(function(t){return t._maybeReact()}))},_set:function(t){z.globalEpoch++,this._epoch++,this._value=t},get:function(){for(var t,n=M;null!==n;){if(t=n.id2txnAtom[this._id],void 0!==t)return b(m(this),t._epoch),t._value;n=n.parent}return b(m(this),this._epoch),this._value},_getEpoch:function(){for(var t,n=M;null!==n;){if(t=n.id2txnAtom[this._id],void 0!==t)return t._epoch;n=n.parent}return this._epoch}}}function w(t,n){return t._id=u(),t._reactors=[],t._epoch=0,t._value=n,t._type=B,t._equals=null,t}function A(t){return function(){var n,r=c(arguments,0),e=this;return _(function(){n=t.apply(e,r)}),n}}function q(){Q?Q.refCount++:(Q=y(),Q.refCount=1);var t=!1;return{tick:function(){if(t)throw new Error("tyring to use ticker after release");Q.tick()},release:function(){if(t)throw new Error("ticker already released");0===--Q.refCount&&(Q.stop(),Q=null),t=!0}}}function O(t,n){this._derivable=n,t&&(this.react=t),this._atoms=[],this._parent=null,this._active=!1,this._yielding=!1,this._reacting=!1,this._type=K,N&&(this.stack=Error().stack)}function x(t,n){if(t._type===B)i(n,t);else for(var r=0,e=t._lastParentsEpochs.length;e>r;r+=2)x(t._lastParentsEpochs[r],n)}function D(t,n){var r={derive:function(n,r,e,i,o){var u=this;switch(arguments.length){case 0:return u;case 1:switch(typeof n){case"function":return t.derivation(function(){return n(u.get())});case"string":case"number":return t.derivation(function(){return u.get()[t.unpack(n)]});default:if(n instanceof Array)return n.map(function(t){return u.derive(t)});if(n instanceof RegExp)return t.derivation(function(){return u.get().match(n)});if(t.isDerivable(n))return t.derivation(function(){var r=n.get(),e=u.get();switch(typeof r){case"function":return r(e);case"string":case"number":return e[r];default:if(r instanceof RegExp)return e.match(r);
throw Error("type error")}return u.get()[t.unpack(n)]});throw Error("type error")}break;case 2:return t.derivation(function(){return n(u.get(),t.unpack(r))});case 3:return t.derivation(function(){return n(u.get(),t.unpack(r),t.unpack(e))});case 4:return t.derivation(function(){return n(u.get(),t.unpack(r),t.unpack(e),t.unpack(i))});case 5:return t.derivation(function(){return n(u.get(),t.unpack(r),t.unpack(e),t.unpack(i),t.unpack(o))});default:var a=[u].concat(c(arguments,1));return t.derivation(function(){return n.apply(null,a.map(t.unpack))})}},reactor:function(t){if("function"==typeof t)return new O(t,this);if(t instanceof O){if("function"!=typeof t.react)throw new Error("reactor missing .react method");return t._derivable=this,t}if(t&&t.react)return F(new O(null,this),t);throw new Error("Unrecognized type for reactor "+t)},react:function(n,r){function e(n,r){if(!t.isDerivable(n))if("function"==typeof n)n=t.derivation(n);else{if("boolean"!=typeof n)throw Error("react "+r+" condition must be derivable");n=t.atom(n)}return n.derive(function(t){return!!t})}if("function"!=typeof n)throw Error("the first argument to .react must be a function");r=F({once:!1,from:!0,until:!1,when:!0,skipFirst:!1},r);var i=this.reactor({react:function(t){r.skipFirst?r.skipFirst=!1:(n(t),r.once&&(this.stop(),o.stop()))},onStart:r.onStart,onStop:r.onStop}),o=t.struct({until:e(r.until,"until"),when:e(r.when,"when")}).reactor(function(t){t.until?(i.stop(),this.stop()):t.when?i.isActive()||i.start().force():i.isActive()&&i.stop()});e(r.from,"from").reactor(function(t){t&&(o.start().force(),this.stop())}).start().force()},is:function(r){return t.lift(this._equals||n.equals)(this,r)},and:function(n){return this.derive(function(r){return r&&t.unpack(n)})},or:function(n){return this.derive(function(r){return r||t.unpack(n)})},then:function(n,r){return this.derive(function(e){return t.unpack(e?n:r)})},mThen:function(n,r){return this.derive(function(e){return t.unpack(a(e)?n:r)})},mOr:function(t){return this.mThen(this,t)},mDerive:function(t){if(1===arguments.length&&t instanceof Array){
var n=this;return t.map(function(t){return n.mDerive(t)})}return this.mThen(this.derive.apply(this,arguments))},mAnd:function(t){return this.mThen(t,this)},not:function(){return this.derive(function(t){return!t})},withEquality:function(t){if(t){if("function"!=typeof t)throw new Error("equals must be function")}else t=null;return h(this._clone(),t)},__equals:function(t,r){return(this._equals||n.equals)(t,r)}};return r["switch"]=function(){var r=arguments;return this.derive(function(e){var i;for(i=0;r.length-1>i;i+=2)if(n.equals(e,t.unpack(r[i])))return t.unpack(r[i+1]);return i===r.length-1?t.unpack(r[i]):void 0})},r}function R(t,n){return{_clone:function(){return h(t.derivation(this._deriver),this._equals)},_forceEval:function(){var t=this,n=null,r=E(function(){if(N)try{n=t._deriver()}catch(r){throw console.error(t.stack),r}else n=t._deriver()});this.__equals(n,this._value)||this._epoch++,this._lastParentsEpochs=r,this._value=n},_update:function(){var t=null===M?z.globalEpoch:M.globalEpoch;if(this._lastGlobalEpoch!==t){if(this._value===I)this._forceEval();else for(var n=0,r=this._lastParentsEpochs.length;r>n;n+=2){var e,i=this._lastParentsEpochs[n],o=this._lastParentsEpochs[n+1];if(i._type===B?e=i._getEpoch():(i._update(),e=i._epoch),e!==o)return void this._forceEval()}this._lastGlobalEpoch=t}},get:function(){var t=m(this);return this._update(),b(t,this._epoch),this._value}}}function S(t,n){return t._deriver=n,t._lastParentsEpochs=[],t._lastGlobalEpoch=z.globalEpoch-1,t._epoch=0,t._type=H,t._value=I,t._equals=null,N&&(t.stack=Error().stack),t}function j(t,n){return{swap:function(t){var n=c(arguments,0);return n[0]=this.get(),this.set(t.apply(null,n))},lens:function(n){var r=this;return t.lens({get:function(){return n.get(r.get())},set:function(t){r.set(n.set(r.get(),t))}})}}}function P(t,n){return{_clone:function(){return h(t.lens(this._lensDescriptor),this._equals)},set:function(n){var r=this;return t.atomically(function(){r._lensDescriptor.set(n)}),this}}}function T(t,n){return t._lensDescriptor=n,t._type=J,t}function C(t){
function n(t){if(u.isDerivable(t))return t.get();if(t instanceof Array)return t.map(n);if(t.constructor===Object){for(var r={},e=V(t),i=e.length;i--;){var o=e[i];r[o]=n(t[o])}return r}return t}function r(t){return function(){var n=arguments;return u.derivation(function(){for(var r,e=0;n.length>e&&(r=u.unpack(n[e]),!t(r));e++);return r})}}function i(t){return t}function o(t){return function(n){return!t(n)}}t=F({},X,t||{});var u={transact:_,defaultEquals:e,setDebugMode:s,transaction:A,ticker:q,Reactor:O,isAtom:function(t){return t&&(t._type===B||t._type===J)},isDerivable:function(t){return t&&(t._type===B||t._type===J||t._type===H)},isDerivation:function(t){return t&&(t._type===H||t._type===J)},isLensed:function(t){return t&&t._type===J},isReactor:function(t){return t&&t._type===K}},h=D(u,t),f=j(u,t),l=F({},f,h,k(u,t)),v=F({},h,R(u,t)),d=F({},f,v,P(u,t));return u.atom=function(t){return w(Object.create(l),t)},u.atomic=function(t){return function(){var n,r=this,e=arguments;return u.atomically(function(){n=t.apply(r,e)}),n}},u.atomically=function(t){p()?t():u.transact(t)},u.derivation=function(t){return S(Object.create(v),t)},u.derive=function(t){var n=c(arguments,1);return u.derivation(function(){for(var r="",e=0;t.length>e;e++)r+=t[e],n.length>e&&(r+=u.unpack(n[e]));return r})},u.lens=function(t){return T(S(Object.create(d),t.get),t)},u.unpack=function(t){return u.isDerivable(t)?t.get():t},u.lift=function(t){return function(){var n=arguments,r=this;return u.derivation(function(){return t.apply(r,Array.prototype.map.call(n,u.unpack))})}},u.struct=function(t){if(t.constructor===Object||t instanceof Array)return u.derivation(function(){return n(t)});throw new Error("`struct` expects plain Object or Array")},u.or=r(i),u.mOr=r(a),u.and=r(o(i)),u.mAnd=r(o(a)),u}var V=Object.keys,F=Object.assign||n,G=0,I=Object.freeze({equals:function(){return!1}}),N=!1,z={globalEpoch:0},L={},M=null,U=[],B="ATOM",H="DERIVATION",J="LENS",K="REACTION",Q=null,W=[];F(O.prototype,{start:function(){this._lastValue=this._derivable.get(),this._lastEpoch=this._derivable._epoch,
this._atoms=[],x(this._derivable,this._atoms);var t=this;this._atoms.forEach(function(n){i(n._reactors,t)});var n=W.length;return n>0&&(this._parent=W[n-1]),this._active=!0,this.onStart&&this.onStart(),this},_force:function(t){try{W.push(this),this._reacting=!0,this.react(t)}catch(n){throw N&&console.error(this.stack),n}finally{this._reacting=!1,W.pop()}},force:function(){return this._force(this._derivable.get()),this},_maybeReact:function(){if(this._reacting)throw Error("cyclical update detected!!");if(this._active){if(this._yielding)throw Error("reactor dependency cycle detected");if(null!==this._parent&&(this._yielding=!0,this._parent._maybeReact(),this._yielding=!1),this._active){var t=this._derivable.get();this._derivable._epoch===this._lastEpoch||this._derivable.__equals(t,this._lastValue)||this._force(t),this._lastEpoch=this._derivable._epoch,this._lastValue=t;var n=this._atoms,r=[];this._atoms=r,x(this._derivable,r);var e=this;r.forEach(function(t){var r=n.indexOf(t);-1===r?i(t._reactors,e):n[r]=null}),n.forEach(function(t){null!==t&&o(t._reactors,e)})}}},stop:function(){var t=this;return this._atoms.forEach(function(n){return o(n._reactors,t)}),this._atoms=[],this._parent=null,this._active=!1,this.onStop&&this.onStop(),this},orphan:function(){return this._parent=null,this},adopt:function(t){return t._parent=this,this},isActive:function(){return this._active}});var X={equals:e};F(t,C()),t.withEquality=function(t){return C({equals:t})},t["default"]=t});
//# sourceMappingURL=derivable.min.js.map