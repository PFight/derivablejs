"use strict";function t(t){for(var n=1;n<arguments.length;n++)for(var e=arguments[n],r=W(e||{}),i=r.length;i--;){var u=r[i];t[u]=e[u]}return t}function n(t,n){return t===n?0!==t||1/t===1/n:t!==t&&n!==n}function e(t,e){return n(t,e)||t&&"function"==typeof t.equals&&t.equals(e)}function r(t,n){var e=t.indexOf(n);e<0&&t.push(n)}function i(t,n){var e=t.indexOf(n);e>=0&&t.splice(e,1)}function u(){return X++}function o(t,n){return Array.prototype.slice.call(t,n)}function s(t){return null!==t&&void 0!==t}function a(t){Z=!!t}function c(t,n){return t._equals=n,t}function f(t){return t&&(t._type===tt||t._type===$||t._type===nt)}function h(t){return t&&(t._type===$||t._type===nt)}function l(t){return t&&(t._type===tt||t._type===nt)}function _(t){return t&&t._type===nt}function p(t,n){st.push({parents:n,offset:0,child:t}),at=t}function v(){return st[st.length-1]}function d(){st.pop(),at=0===st.length?null:st[st.length-1].child}function g(t){if(null!==at){var n=st[st.length-1];if(n.parents[n.offset]===t)n.offset++;else{var e=n.parents.indexOf(t);if(e===-1)r(t._activeChildren,at),n.parents.push(n.parents[n.offset]),n.parents[n.offset]=t,n.offset++;else if(e>n.offset){var i=n.parents[e];n.parents[e]=n.parents[n.offset],n.parents[n.offset]=i,n.offset++}}}}function y(t,n){for(var e=0,r=t._activeChildren.length;e<r;e++){var i=t._activeChildren[e];switch(i._type){case tt:case nt:i._state!==rt&&(i._state=rt,y(i,n));break;case et:n.push(i)}}}function m(t){for(var n=0,e=t.length;n<e;n++){var r=t[n];if(r._reacting)throw new Error("Synchronous cyclical reactions disallowed. Use setImmediate.");r._maybeReact()}}function w(){throw ct}function E(t){this.parent=t,this.id2originalValue={},this.modifiedAtoms=[]}function b(t){null!==ft&&(t._id in ft.id2originalValue||(ft.modifiedAtoms.push(t),ft.id2originalValue[t._id]=t._value))}function k(){return null!==ft}function q(t){D();try{t.call(null,w)}catch(n){if(R(),n!==ct)throw n;return}x()}function A(t){k()?t():q(t)}function O(t){return function(){var n,e=o(arguments,0),r=this;return q(function(){
n=t.apply(r,e)}),n}}function C(t){return function(){var n,e=o(arguments,0),r=this;return A(function(){n=t.apply(r,e)}),n}}function D(){ft=new E(ft)}function x(){var t=ft;if(ft=t.parent,null===ft){var n=[];t.modifiedAtoms.forEach(function(e){e.__equals(e._value,t.id2originalValue[e._id])?e._state=ut:(e._state=it,y(e,n))}),m(n),t.modifiedAtoms.forEach(function(t){t._state=ut})}}function R(){var t=ft;ft=t.parent,t.modifiedAtoms.forEach(function(n){n._value=t.id2originalValue[n._id],n._state=ut,y(n,[])})}function T(){0===ht&&D(),ht++;var t=!1;return{tick:function(){if(t)throw new Error("trying to use ticker after release");x(),D()},reset:function(){if(t)throw new Error("trying to use ticker after release");R(),D()},release:function(){if(t)throw new Error("ticker already released");ht--,t=!0,0===ht&&x()}}}function j(t){this._deriver=t,this._parents=null,this._type=tt,this._value=Y,this._equals=null,this._activeChildren=[],this._state=ot,Z&&(this.stack=Error().stack)}function V(t,n){if(i(t._activeChildren,n),0===t._activeChildren.length&&null!=t._parents){for(var e=t._parents.length,r=0;r<e;r++)V(t._parents[r],t);t._parents=null,t._state=ot}}function F(t){return new j(t)}function I(t,n,e){this._parent=t,this.react=n,this._governor=e||null,this._active=!1,this._reacting=!1,this._type=et,Z&&(this.stack=Error().stack)}function N(n,e,r){function i(t,n){if(!f(t)){if("function"==typeof t)return F(t);if("boolean"==typeof t)return F(function(){return t});throw Error("react "+n+" condition must be derivable, got: "+JSON.stringify(t))}return t}if("function"!=typeof e)throw Error("the first argument to .react must be a function");r=t({once:!1,from:!0,until:!1,when:!0,skipFirst:!1},r);var u=new I(n,function(t){r.skipFirst?r.skipFirst=!1:(e(t),r.once&&(this.stop(),c.stop()))}),o=i(r.until,"until"),s=i(r.when,"when"),a=F(function(){return{until:o.get(),when:s.get()}}),c=new I(a,function(t){t.until?(u.stop(),this.stop()):t.when?u._active||u.start().force():u._active&&u.stop()});u._governor=c;var h=i(r.from,"from"),l=new I(h,function(t){
t&&(c.start().force(),this.stop())});l.start().force()}function S(t){return this._id=u(),this._activeChildren=[],this._value=t,this._state=ut,this._type=$,this._equals=null,this}function z(t){return new S(t)}function L(t){j.call(this,t.get),this._lensDescriptor=t,this._type=nt}function M(t){return new L(t)}function J(t){var n=o(arguments,1);return wt(function(){for(var e="",r=0;r<t.length;r++)e+=t[r],r<n.length&&(e+=U(n[r]));return e})}function U(t){return dt(t)?t.get():t}function B(t){return function(){var n=arguments,e=this;return wt(function(){return t.apply(e,Array.prototype.map.call(n,U))})}}function G(t){if(dt(t))return t.get();if(t instanceof Array)return t.map(G);if(t.constructor===Object){for(var n={},e=W(t),r=e.length;r--;){var i=e[r];n[i]=G(t[i])}return n}return t}function H(t){if(t.constructor===Object||t instanceof Array)return wt(function(){return G(t)});throw new Error("`struct` expects plain Object or Array")}function K(t){return function(){var n=arguments;return wt(function(){for(var e,r=0;r<n.length&&(e=U(n[r]),!t(e));r++);return e})}}function P(t){return t}function Q(t){return function(n){return!t(n)}}var W=Object.keys,X=0,Y=Object.freeze({equals:function(){return!1}}),Z=!1,$="ATOM",tt="DERIVATION",nt="LENS",et="REACTOR",rt=0,it=1,ut=2,ot=3,st=[],at=null,ct={},ft=null,ht=0;t(j.prototype,{_clone:function(){return c(F(this._deriver),this._equals)},_forceEval:function(){var t,n=this,e=null;try{if(null===this._parents&&(this._parents=[]),p(this,this._parents),Z)try{e=n._deriver()}catch(r){throw console.error(n.stack),r}else e=n._deriver();t=v().offset}finally{d()}for(this._state=this.__equals(e,this._value)?ut:it;t<this._parents.length;){var i=this._parents[t++];V(i,this)}this._value=e},_update:function(){if(null===this._parents)this._forceEval();else if(this._state===rt)for(var t=this._parents.length,n=0;n<t;n++){var e=this._parents[n];if(e._state===rt&&e._update(),e._state===it){this._forceEval();break}}},get:function(){return this._activeChildren.length>0?(g(this),this._update(),this._value):this._deriver();
}}),t(I.prototype,{start:function(){return this._active=!0,r(this._parent._activeChildren,this),this._parent.get(),this},_force:function(t){try{this._reacting=!0,this.react(t)}catch(n){throw Z&&console.error(this.stack),n}finally{this._reacting=!1}},force:function(){return this._force(this._parent.get()),this},_maybeReact:function(){if(!this._reacting&&this._active&&(null!==this._governor&&this._governor._maybeReact(),this._active)){var t=this._parent.get();this._parent._state===it&&this._force(t)}},stop:function(){return V(this._parent,this),this._active=!1,this}}),t(S.prototype,{_clone:function(){return c(z(this._value),this._equals)},set:function(t){b(this);var n=this._value;if(this._value=t,!k()&&!this.__equals(t,n))try{this._state=it;var e=[];y(this,e),m(e)}finally{this._state=ut}},get:function(){return g(this),this._value}}),t(L.prototype,j.prototype,{_clone:function(){return c(new L(this._lensDescriptor),this._equals)},set:function(t){var n=this;return A(function(){n._lensDescriptor.set(t)}),this}});var lt=q,_t=a,pt=O,vt=T,dt=f,gt=h,yt=_,mt=l,wt=F,Et=z,bt=C,kt=A,qt=M,At=K(P),Ot=K(s),Ct=K(Q(P)),Dt=K(Q(s)),xt=Object.freeze({transact:lt,setDebugMode:_t,transaction:pt,ticker:vt,isDerivable:dt,isAtom:gt,isLensed:yt,isDerivation:mt,derivation:wt,atom:Et,atomic:bt,atomically:kt,lens:qt,derive:J,unpack:U,lift:B,struct:H,or:At,mOr:Ot,and:Ct,mAnd:Dt}),Rt={derive:function(t,n,e,r,i){var u=this;switch(arguments.length){case 0:throw new Error(".derive takes at least one argument");case 1:switch(typeof t){case"function":return wt(function(){return t(u.get())});case"string":case"number":return wt(function(){return u.get()[U(t)]});default:if(t instanceof Array)return t.map(function(t){return u.derive(t)});if(t instanceof RegExp)return wt(function(){return u.get().match(t)});if(f(t))return wt(function(){var n=t.get(),e=u.get();switch(typeof n){case"function":return n(e);case"string":case"number":return e[n];default:if(n instanceof RegExp)return e.match(n);throw Error("type error")}});throw Error("type error")}case 2:return wt(function(){
return t(u.get(),U(n))});case 3:return wt(function(){return t(u.get(),U(n),U(e))});case 4:return wt(function(){return t(u.get(),U(n),U(e),U(r))});case 5:return wt(function(){return t(u.get(),U(n),U(e),U(r),U(i))});default:var s=[u].concat(o(arguments,1));return wt(function(){return t.apply(null,s.map(U))})}},react:function(t,n){N(this,t,n)},is:function(t){return B(this._equals||e)(this,t)},and:function(t){return this.derive(function(n){return n&&U(t)})},or:function(t){return this.derive(function(n){return n||U(t)})},then:function(t,n){return this.derive(function(e){return U(e?t:n)})},mThen:function(t,n){return this.derive(function(e){return U(s(e)?t:n)})},mOr:function(t){return this.mThen(this,t)},mDerive:function(t){if(1===arguments.length&&t instanceof Array){var n=this;return t.map(function(t){return n.mDerive(t)})}return this.mThen(this.derive.apply(this,arguments))},mAnd:function(t){return this.mThen(t,this)},not:function(){return this.derive(function(t){return!t})},withEquality:function(t){if(t){if("function"!=typeof t)throw new Error("equals must be function")}else t=null;return c(this._clone(),t)},__equals:function(t,n){return(this._equals||e)(t,n)}};Rt["switch"]=function(){var t=arguments,n=this;return this.derive(function(e){var r;for(r=0;r<t.length-1;r+=2)if(n.__equals(e,U(t[r])))return U(t[r+1]);if(r===t.length-1)return U(t[r])})};var Tt={swap:function(t){var n=o(arguments,0);return n[0]=this.get(),this.set(t.apply(null,n))},lens:function(t){var n=this;return new L({get:function(){return t.get(n.get())},set:function(e){n.set(t.set(n.get(),e))}})}};t(j.prototype,Rt),t(L.prototype,Rt,Tt),t(S.prototype,Rt,Tt),module.exports=xt,module.exports=xt;
//# sourceMappingURL=dist/derivable.min.js.map
//# sourceMappingURL=derivable.min.js.map