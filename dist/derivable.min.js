"use strict";function t(t){for(var n=1;arguments.length>n;n++)for(var e=arguments[n],r=X(e||{}),i=r.length;i--;){var u=r[i];t[u]=e[u]}return t}function n(t,n){return t===n?0!==t||1/t===1/n:t!==t&&n!==n}function e(t,e){return n(t,e)||t&&"function"==typeof t.equals&&t.equals(e)}function r(t,n){var e=t.indexOf(n);0>e&&t.push(n)}function i(t,n){var e=t.indexOf(n);e>=0&&t.splice(e,1)}function u(){return Z++}function o(t,n){return Array.prototype.slice.call(t,n)}function s(t){return null!==t&&void 0!==t}function a(t){tt=!!t}function c(t,n){return t._equals=n,t}function f(t){return t&&t.type===et||t.type===nt||t.type===rt}function h(t){return t&&(t._type===nt||t._type===rt)}function l(t){return t&&(t._type===et||t._type===rt)}function _(t){return t&&t._type===rt}function p(t){return t&&t._type===it}function v(t){ct.push([])}function d(){return ct[ct.length-1]}function g(){ct.pop(),ft=null}function y(t){null!==ft&&(ct[ct.length-1].push(t),r(t._activeChildren,ft))}function m(t,n){for(var e=0,r=t._activeChildren.length;r>e;e++){var i=t._activeChildren[e];switch(i._type){case et:case rt:i._state!==ut&&(i._state=ut,m(i,n));break;case it:n.push(i);break;default:throw new Error("Unrecognized child type")}}}function w(t){for(var n=0,e=t.length;e>n;n++){var r=t[n];if(r._reacting)throw new Error("Synchronous cyclical reactions disallowed. Use setImmediate.");r._maybeReact()}}function E(){throw ht}function b(t){this.parent=t,this.id2originalValue={},this.modifiedAtoms=[]}function A(t){if(null!==lt){var n=lt.modifiedAtoms.indexOf(t);-1===n&&lt.modifiedAtoms.push(t),lt.id2originalValue[t._id]=t._value}}function k(){return null!==lt}function q(t){D();try{t.call(null,E)}catch(n){if(j(),n!==ht)throw n;return}R()}function O(t){k()?t():q(t)}function C(t){return function(){var n,e=o(arguments,0),r=this;return q(function(){n=t.apply(r,e)}),n}}function x(t){return function(){var n,e=o(arguments,0),r=this;return O(function(){n=t.apply(r,e)}),n}}function D(){lt=new b(lt)}function R(){var t=lt;if(lt=t.parent,null===lt){var n=[];t.modifiedAtoms.forEach(function(e){
e.__equals(e._value,t.id2originalValue[e._id])?e._state=st:(e._state=ot,m(e,n))}),w(n),t.modifiedAtoms.forEach(function(t){t._state=st})}}function j(){lt.modifiedAtoms.forEach(function(t){t._value=lt.id2originalValue[t._id],m(t,[])})}function T(){0===_t&&D(),_t++;var t=!1;return{tick:function(){if(t)throw new Error("trying to use ticker after release");R(),D()},reset:function(){if(t)throw new Error("trying to use ticker after release");j(),D()},release:function(){if(t)throw new Error("ticker already released");_t--,t=!0,0===_t&&R()}}}function V(t){this._deriver=t,this._parents=null,this._type=et,this._value=$,this._equals=null,this._activeChildren=[],this._state=at,tt&&(this.stack=Error().stack)}function z(t,n){if(i(t._activeChildren,n),0===t._activeChildren.length&&null!=t._parents){for(var e=t._parents.length,r=0;e>r;r++)z(t._parents[r],t);t._parents=null,t._state=at}}function F(t){return new V(t)}function I(t,n,e){this._parent=t,n&&(this.react=n),this._governor=e||null,this._active=!1,this._reacting=!1,this._type=it,tt&&(this.stack=Error().stack)}function L(t,n,e){function r(t,n){if(!f(t))if("function"==typeof t)t=F(t);else{if("boolean"!=typeof t)throw Error("react "+n+" condition must be derivable");t=F(function(){return t})}return t}if("function"!=typeof n)throw Error("the first argument to .react must be a function");e=Y({once:!1,from:!0,until:!1,when:!0,skipFirst:!1},e);var i=new I(t,function(t){e.skipFirst?e.skipFirst=!1:(n(t),e.once&&(this.stop(),a.stop()))}),u=r(e.until,"until"),o=r(e.when,"when"),s=F(function(){return{until:u.get(),when:o.get()}}),a=new I(s,function(t){t.until?(i.stop(),this.stop()):t.when?i.isActive()||i.start().force():i.isActive()&&i.stop()});i._governor=a;var c=new I(r(e.from,"from"),function(t){t&&(a.start().force(),this.stop())});a._governor=c,c.start().force()}function M(t){return this._id=u(),this._activeChildren=[],this._value=t,this._state=st,this._type=nt,this._equals=null,this}function N(t){return new M(t)}function S(t){V.call(this,t.get),this._lensDescriptor=t,this._type=rt;
}function U(t){return new S(t)}function B(t){var n=o(arguments,1);return At(function(){for(var e="",r=0;t.length>r;r++)e+=t[r],n.length>r&&(e+=G(n[r]));return e})}function G(t){return yt(t)?t.get():t}function H(t){return function(){var n=arguments,e=this;return At(function(){return t.apply(e,Array.prototype.map.call(n,G))})}}function J(t){if(yt(t))return t.get();if(t instanceof Array)return t.map(J);if(t.constructor===Object){for(var n={},e=X(t),r=e.length;r--;){var i=e[r];n[i]=J(t[i])}return n}return t}function K(t){if(t.constructor===Object||t instanceof Array)return At(function(){return J(t)});throw new Error("`struct` expects plain Object or Array")}function P(t){return function(){var n=arguments;return At(function(){for(var e,r=0;n.length>r&&(e=G(n[r]),!t(e));r++);return e})}}function Q(t){return t}function W(t){return function(n){return!t(n)}}var X=Object.keys,Y=Object.assign;Y||(Y=t);var Z=0,$=Object.freeze({equals:function(){return!1}}),tt=!1,nt="ATOM",et="DERIVATION",rt="LENS",it="REACTOR",ut=0,ot=1,st=2,at=3,ct=[],ft=null,ht={},lt=null,_t=0;Y(V.prototype,{_clone:function(){return c(F(this._deriver),this._equals)},_forceEval:function(){var t=this,n=null,e=null;try{if(v(),tt)try{n=t._deriver()}catch(r){throw console.error(t.stack),r}else n=t._deriver();e=d()}finally{g()}if(this._state=this.__equals(n,this._value)?st:ot,this._parents)for(var i=this._parents.length,u=0;i>u;u++){var o=this._parents[u];-1===e.indexOf(o)&&z(o,this)}this._parents=e,this._value=n},_update:function(){if(null===this._parents)this._forceEval();else if(this._state===ut)for(var t=this._parents.length,n=0;t>n;n++)if(this._parents[n]._state!==st){this._forceEval();break}},get:function(){return this._activeChildren.length>0?(y(this),this._update(),this._value):this._deriver()}}),Y(I.prototype,{start:function(){if(this._active)throw new Error("already active");return this._active=!0,r(this._parent._activeChildren,this),this._parent._state===at&&(this._parent._state=ut),this._parent.get(),this},_force:function(t){try{this._reacting=!0,this.react(t);
}catch(n){throw tt&&console.error(this.stack),n}finally{this._reacting=!1}},force:function(){return this._force(this._parent.get()),this},_maybeReact:function(){if(!this._reacting&&this._active&&(null!==this._governor&&this._governor._maybeReact(),this._active)){var t=this._parent.get();this._parent._state===ot&&this._force(t)}},stop:function(){return z(this._parent,this),this._active=!1,this}}),Y(M.prototype,{_clone:function(){return c(N(this._value),this._equals)},set:function(t){A(this);var n=this._value;if(this._value=t,!k()&&!this.__equals(t,n))try{this._state=ot;var e=[];m(this,e),w(e)}finally{this._state=st}},get:function(){return y(this),this._value}}),Y(S.prototype,V.prototype,{_clone:function(){return c(new S(this._lensDescriptor),this._equals)},set:function(t){var n=this;return O(function(){n._lensDescriptor.set(t)}),this}});var pt=q,vt=a,dt=C,gt=T,yt=f,mt=h,wt=_,Et=l,bt=p,At=F,kt=N,qt=x,Ot=O,Ct=U,xt=P(Q),Dt=P(s),Rt=P(W(Q)),jt=P(W(s)),Tt=Object.freeze({transact:pt,setDebugMode:vt,transaction:dt,ticker:gt,isDerivable:yt,isAtom:mt,isLensed:wt,isDerivation:Et,isReactor:bt,derivation:At,atom:kt,atomic:qt,atomically:Ot,lens:Ct,derive:B,unpack:G,lift:H,struct:K,or:xt,mOr:Dt,and:Rt,mAnd:jt}),Vt={derive:function(t,n,e,r,i){var u=this;switch(arguments.length){case 0:throw new Error(".derive takes at least one argument");case 1:switch(typeof t){case"function":return At(function(){return t(u.get())});case"string":case"number":return At(function(){return u.get()[G(t)]});default:if(t instanceof Array)return t.map(function(t){return u.derive(t)});if(t instanceof RegExp)return At(function(){return u.get().match(t)});if(f(t))return At(function(){var n=t.get(),e=u.get();switch(typeof n){case"function":return n(e);case"string":case"number":return e[n];default:if(n instanceof RegExp)return e.match(n);throw Error("type error")}});throw Error("type error")}case 2:return At(function(){return t(u.get(),G(n))});case 3:return At(function(){return t(u.get(),G(n),G(e))});case 4:return At(function(){return t(u.get(),G(n),G(e),G(r));
});case 5:return At(function(){return t(u.get(),G(n),G(e),G(r),G(i))});default:var s=[u].concat(o(arguments,1));return At(function(){return t.apply(null,s.map(G))})}},react:function(t,n){L(this,t,n)},is:function(t){return H(this._equals||e)(this,t)},and:function(t){return this.derive(function(n){return n&&G(t)})},or:function(t){return this.derive(function(n){return n||G(t)})},then:function(t,n){return this.derive(function(e){return G(e?t:n)})},mThen:function(t,n){return this.derive(function(e){return G(s(e)?t:n)})},mOr:function(t){return this.mThen(this,t)},mDerive:function(t){if(1===arguments.length&&t instanceof Array){var n=this;return t.map(function(t){return n.mDerive(t)})}return this.mThen(this.derive.apply(this,arguments))},mAnd:function(t){return this.mThen(t,this)},not:function(){return this.derive(function(t){return!t})},withEquality:function(t){if(t){if("function"!=typeof t)throw new Error("equals must be function")}else t=null;return c(this._clone(),t)},__equals:function(t,n){return(this._equals||e)(t,n)}};Vt["switch"]=function(){var t=arguments,n=this;return this.derive(function(e){var r;for(r=0;t.length-1>r;r+=2)if(n.__equals(e,G(t[r])))return G(t[r+1]);return r===t.length-1?G(t[r]):void 0})};var zt={swap:function(t){var n=o(arguments,0);return n[0]=this.get(),this.set(t.apply(null,n))},lens:function(t){var n=this;return new S({get:function(){return t.get(n.get())},set:function(e){n.set(t.set(n.get(),e))}})}};Y(V.prototype,Vt),Y(S.prototype,Vt,zt),Y(M.prototype,Vt,zt),module.exports=Tt,module.exports=Tt;
//# sourceMappingURL=dist/derivable.min.js.map
//# sourceMappingURL=derivable.min.js.map