!function(t,n){"use strict";t&&"function"==typeof t.define&&t.define.amd?t.define(["exports"],n):n("undefined"!=typeof exports?exports:t.Derivable={})}(this,function(t){"use strict";function n(t){for(var n=1;n<arguments.length;n++)for(var r=arguments[n],e=tt(r),i=e.length;i--;){var a=e[i];t[a]=r[a]}return t}function r(t,n){return t===n?0!==t||1/t===1/n:t!==t&&n!==n}function e(t,n){return r(t,n)||t&&"function"==typeof t.equals&&t.equals(n)}function i(t,n){var r=t.indexOf(n);0>r&&t.push(n)}function a(t,n){var r=t.indexOf(n);r>=0&&t.splice(r,1)}function u(t,n){return t.indexOf(n)>=0}function o(){return nt++}function c(t,n){return Array.prototype.slice.call(t,n)}function s(t){return null!==t&&void 0!==t}function f(t){et=!!t}function l(t,n){if(t._type===_t){if(t.reacting)throw new Error("Cycle detected! Don't do this!");n.push(t)}else for(var r=t._children.length;r--;){var e=t._children[r];e._state!==ct&&(e._state=ct,l(e,n))}}function h(t){var n;switch(t._state){case at:case ut:for(n=t._children.length;n--;){var r=t._children[n];h(r),r._state!==st&&t._children.splice(n,1)}t._state=st;break;case ct:if(t._type===_t)t._state=st;else{var e=[];for(n=t._parents.length;n--;){var i=t._parents[n];if(i._state!==ut){t._state=ot;break}e.push([i,i._value])}t._state!==ot&&(t._state=ft,t._parents=e)}break;case st:case ot:case ft:break;default:throw new Error("can't sweep state "+t._state)}}function p(t){var n=!1;switch(t._type){case ht:t._state=st,n=!0;break;case pt:case vt:t._state=it,t._value=rt,n=!0;break;case _t:t._state=st,n=!1}if(n){for(var r=t._children.length;r--;)p(t._children[r]);t._children=[]}}function v(t){var n=lt.length;lt.push([]);try{return t(),lt[n]}finally{lt.pop()}}function _(t){lt.length>0&&i(lt[lt.length-1],t)}function d(){throw kt}function g(){return{currentTxn:null}}function y(t){return null!==t.currentTxn}function k(t){return t.currentTxn}function w(t,n){n._parent=t.currentTxn,n._state=dt,t.currentTxn=n}function m(t,n){var r=t.currentTxn;if(t.currentTxn=r._parent,r._state!==dt)throw new Error("unexpected state: "+r._state);
n(r)}function b(t){m(t,function(t){t._state=gt,t.onCommit&&t.onCommit()})}function E(t){m(t,function(t){t._state=yt,t.onAbort&&t.onAbort()})}function T(t,n,r){w(t,n);try{r(d)}catch(e){if(E(t),e!==kt)throw e;return}b(t)}function x(t,n){w(t,n());var r=!1;return{tick:function(){if(r)throw new Error("can't tick disposed ticker");b(t),w(t,n())},stop:function(){if(r)throw new Error("ticker already disposed");b(t)}}}function R(t,n){var r={control:n,parent:t,parentReactor:null,dependentReactors:[],_state:st,active:!1,_type:_t,uid:o(),reacting:!1,stopping:!1,yielding:!1};return et&&(r.stack=Error().stack),r}function A(t){if(t.active){if(t.stopping)throw Error(wt);try{for(t.stopping=!0;t.dependentReactors.length;){var n=t.dependentReactors.pop();A(n)}}finally{a(t.parent._children,t),t.parentReactor&&D(t),t.active=!1,t.stopping=!1}t.control.onStop&&t.control.onStop()}}function O(t){if(!t.active){i(t.parent._children,t),t.active=!0,t.parent._get();var n=mt.length;n>0&&(t.parentReactor=mt[n-1],i(t.parentReactor.dependentReactors,t)),t.control.onStart&&t.control.onStart()}}function D(t){t.parentReactor&&(a(t.parentReactor.dependentReactors,t),t.parentReactor=null)}function V(t,n){D(n),t.active?(n.parentReactor=t,i(t.dependentReactors,n)):A(n)}function q(t){if(t.yielding)throw Error(wt);if(t.active&&t._state===ct){if(null!==t.parentReactor)try{t.yielding=!0,q(t.parentReactor)}finally{t.yielding=!1}if(t.active){var n=t.parent,r=n._state;if((r===ct||r===ot||r===ft||r===it)&&n._get(),r=n._state,r===ut)t._state=st;else{if(r!==at)throw new Error("invalid parent state: "+r);C(t)}}}}function C(t){if(!t.control.react)throw new Error("No reactor function available.");t._state=st;try{if(t.reacting=!0,mt.push(t),et)try{t.control.react(t.parent._get())}catch(n){throw console.error(t.stack),n}else t.control.react(t.parent._get())}finally{mt.pop(),t.reacting=!1}}function j(){this._type=_t}function N(t,n){if(t._base)throw new Error("This reactor has already been initialized");return t._base=R(n,t),t}function S(t){this._type=_t,this.react=t}function G(t){
return n(new j,t)}function I(t,n){var r={derive:function(n,r,e,i,a){var u=this;switch(arguments.length){case 0:return u;case 1:return t.derivation(function(){return n(u.get())});case 2:return t.derivation(function(){return n(u.get(),t.unpack(r))});case 3:return t.derivation(function(){return n(u.get(),t.unpack(r),t.unpack(e))});case 4:return t.derivation(function(){return n(u.get(),t.unpack(r),t.unpack(e),t.unpack(i))});case 5:return t.derivation(function(){return n(u.get(),t.unpack(r),t.unpack(e),t.unpack(i),t.unpack(a))});default:var o=[u].concat(c(arguments,1));return t.derivation(function(){return n.apply(null,o.map(t.unpack))})}},reactor:function(t){if("function"==typeof t)return N(new S(t),this);if(t instanceof j)return N(t,this);if(t&&t.react)return N(G(t),this);throw new Error("Unrecognized type for reactor "+t)},react:function(t){return this.reactor(t).start().force()},reactWhen:function(t,n){var r=this.reactor(n);return t.derive(function(t){return!!t}).react(function(t){t?r.start().force():r.stop()}),r},get:function(){return _(this),this._get()},is:function(r){return t.lift(n.equals)(this,r)},and:function(n){return this.derive(function(r){return r&&t.unpack(n)})},or:function(n){return this.derive(function(r){return r||t.unpack(n)})},then:function(n,r){return this.derive(function(e){return t.unpack(e?n:r)})},mThen:function(n,r){return this.derive(function(e){return t.unpack(s(e)?n:r)})},mOr:function(t){return this.mThen(this,t)},mDerive:function(){return this.mThen(this.derive.apply(this,arguments))},mAnd:function(t){return this.mThen(t,this)},not:function(){return this.derive(function(t){return!t})}};return r["switch"]=function(){var r=arguments;return this.derive(function(e){var i;for(i=0;r.length-1>i;i+=2)if(n.equals(e,t.unpack(r[i])))return t.unpack(r[i+1]);return i===r.length-1?t.unpack(r[i]):void 0})},r}function z(t,n){return{_clone:function(){return t.derivation(this._deriver)},_forceGet:function(){var t,r=this,e=v(function(){var t;if(et)try{t=r._deriver()}catch(e){throw console.error(r._stack),e}else t=r._deriver();
r._state=n.equals(t,r._value)?ut:at,r._value=t});for(t=this._parents.length;t--;){var o=this._parents[t];u(e,o)||a(o._children,this)}for(this._parents=e,t=e.length;t--;)i(e[t]._children,this)},_get:function(){var t,r;t:switch(this._state){case it:case ot:this._forceGet();break;case ct:for(t=0;this._parents.length>t;t++){r=this._parents[t];var e=r._state;if((e===ct||e===ot||e===ft)&&r._get(),e=r._state,e===at){this._forceGet();break t}if(e!==st&&e!==ut)throw new Error("invalid parent mode: "+e)}this._state=ut;break;case ft:var a=[];for(t=0;this._parents.length>t;t++){var u=this._parents[t],o=u[1];if(r=u[0],!n.equals(r._get(),o)){this._parents=[],this._forceGet();break t}a.push(r)}for(t=a.length;t--;)i(a[t]._children,this);this._parents=a,this._state=ut}return this._value}}}function Q(t,n){return t._children=[],t._parents=[],t._deriver=n,t._state=it,t._type=pt,t._value=rt,et&&(t._stack=Error().stack),t}function L(t,n){return{swap:function(t){var n=c(arguments,0);return n[0]=this.get(),this.set(t.apply(null,n))},lens:function(n){var r=this;return t.lens({get:function(){return n.get(r.get())},set:function(t){r.set(n.set(r.get(),t))}})}}}function M(t,n){return{_clone:function(){return t.lens(this._lensDescriptor)},set:function(n){var r=this;return t.atomically(function(){r._lensDescriptor.set(n)}),this}}}function W(t,n){return t._lensDescriptor=n,t._type=vt,t}function F(t){for(var n=t.length;n--;)q(t[n])}function U(){return y(bt)}function B(){this.inTxnValues={},this.reactorQueue=[]}function H(t,n){var r=t.inTxnValues[n._uid];return r?r[1]:n._value}function J(t,n,r){t.inTxnValues[n._uid]=[n,r],l(n,t.reactorQueue)}function K(t,n){return{_clone:function(){return t.atom(this._value)},withValidator:function(t){if(null===t)return this._clone();if("function"==typeof t){var n=this._clone(),r=this._validator;return n._validator=r?function(n){return t(n)&&r(n)}:t,n}throw new Error(".withValidator expects function or null")},validate:function(){this._validate(this.get())},_validate:function(t){var n=this._validator&&this._validator(t);
if(this._validator&&n!==!0)throw new Error("Failed validation with value: '"+t+"'. Validator returned '"+n+"' ")},set:function(t){if(this._validate(t),!n.equals(t,this._value))if(this._state=at,U())J(k(bt),this,t);else{this._value=t;var r=[];l(this,r),F(r),h(this)}return this},_get:function(){return U()?H(k(bt),this):this._value}}}function P(t,n){return t._uid=o(),t._children=[],t._state=st,t._value=n,t._type=ht,t}function X(t){T(bt,new B,t)}function Y(t){return function(){var n,r=c(arguments,0),e=this;return X(function(){n=t.apply(e,r)}),n}}function Z(){Tt?Tt.refCount++:(Tt=x(bt,function(){return new B}),Tt.refCount=1);var t=!1;return{tick:function(){if(t)throw new Error("tyring to use ticker after release");Tt.tick()},release:function(){if(t)throw new Error("ticker already released");0===--Tt.refCount&&(Tt.stop(),Tt=null),t=!0}}}function $(t){function r(t){var n=c(arguments,1);return a.derivation(function(){for(var r="",e=0;t.length>e;e++)r+=t[e],n.length>e&&(r+=a.unpack(n[e]));return r})}function i(t){if(a.isDerivable(t))return t.get();if(t instanceof Array)return t.map(i);if(t.constructor===Object){for(var n={},r=tt(t),e=r.length;e--;){var u=r[e];n[u]=i(t[u])}return n}return t}t=n({},xt,t||{});var a={transact:X,defaultEquals:e,setDebugMode:f,transaction:Y,ticker:Z,Reactor:j,isAtom:function(t){return t&&(t._type===ht||t._type===vt)},isDerivable:function(t){return t&&(t._type===ht||t._type===vt||t._type===pt)},isDerivation:function(t){return t&&(t._type===pt||t._type===vt)},isLensed:function(t){return t&&t._type===vt},isReactor:function(t){return t&&t._type===_t}},u=I(a,t),o=L(a,t),l=n({},o,u,K(a,t)),h=n({},u,z(a,t)),p=n({},o,h,M(a,t));return a.atom=function(t){return P(Object.create(l),t)},a.atomic=function(t){return function(){var n,r=this,e=arguments;return a.atomically(function(){n=t.apply(r,e)}),n}},a.atomically=function(t){U()?t():a.transact(t)},a.swap=function(t,n){var r=c(arguments,1);return r[0]=t.get(),t.set(n.apply(null,r))},a.derivation=function(t){return Q(Object.create(h),t)},a.derive=function(t){if(t instanceof Array)return r.apply(null,arguments);
if(arguments.length>0)return u.derive.apply(t,c(arguments,1));throw new Error("Wrong arity for derive. Expecting 1+ args")},a.mDerive=function(t){return u.mDerive.apply(t,c(arguments,1))},a.lens=function(t,n){var r=Object.create(p);return 1===arguments.length?(n=t,W(Q(r,n.get),n)):t.lens(n)},a.unpack=function(t){return a.isDerivable(t)?t.get():t},a.lift=function(t){return function(){var n=arguments,r=this;return a.derivation(function(){return t.apply(r,Array.prototype.map.call(n,a.unpack))})}},a.set=function(t,n){return t.set(n)},a.get=function(t){return t.get()},a.struct=function(t){if(t.constructor===Object||t instanceof Array)return a.derivation(function(){return i(t)});throw new Error("`struct` expects plain Object or Array")},a.destruct=function(t){for(var n=arguments,r=[],e=1;n.length>e;e++)r.push(a.lookup(t,n[e]));return r},a.lookup=function(t,n){return a.derivation(function(){return a.unpack(t)[a.unpack(n)]})},a.ifThenElse=function(t,n,r){return t.then(n,r)},a.ifThenElse=function(t,n,r){return a.derivation(function(){return a.unpack(a.unpack(t)?n:r)})},a.mIfThenElse=function(t,n,r){return a.derivation(function(){var e=a.unpack(t);return a.unpack(s(e)?n:r)})},a.or=function(){var t=arguments;return a.derivation(function(){for(var n,r=0;t.length>r&&!(n=a.unpack(t[r]));r++);return n})},a.mOr=function(){var t=arguments;return a.derivation(function(){for(var n,r=0;t.length>r&&(n=a.unpack(t[r]),!s(n));r++);return n})},a.and=function(){var t=arguments;return a.derivation(function(){for(var n,r=0;t.length>r&&(n=a.unpack(t[r]),n);r++);return n})},a.mAnd=function(){var t=arguments;return a.derivation(function(){for(var n,r=0;t.length>r&&(n=a.unpack(t[r]),s(n));r++);return n})},a.not=function(t){return t.derive(function(t){return!t})},a.switchCase=function(t){return u["switch"].apply(t,c(arguments,1))},a}var tt=Object.keys,nt=0,rt=Object.freeze({equals:function(){return!1}}),et=!1,it=0,at=1,ut=2,ot=3,ct=4,st=5,ft=6,lt=[],ht="ATOM",pt="DERIVATION",vt="LENS",_t="REACTION",dt=0,gt=1,yt=3,kt={},wt="Cyclical Reactor Dependency! Not allowed!",mt=[];
n(j.prototype,{start:function(){return O(this._base),this},stop:function(){return A(this._base),this},force:function(){return C(this._base),this},isActive:function(){return this._base.active},orphan:function(){return D(this._base),this},adopt:function(t){if(t._type!==_t)throw Error("reactors can only adopt reactors");return V(this._base,t._base),this}}),n(S.prototype,j.prototype);var bt=g(),Et={push:function(){}};n(B.prototype,{onCommit:function(){var t,n,r=tt(this.inTxnValues);if(U())for(t=r.length;t--;)n=this.inTxnValues[r[t]],n[0].set(n[1]);else{for(t=r.length;t--;)n=this.inTxnValues[r[t]],n[0]._value=n[1],l(n[0],Et);for(F(this.reactorQueue),t=r.length;t--;)h(this.inTxnValues[r[t]][0])}},onAbort:function(){if(!U())for(var t=tt(this.inTxnValues),n=t.length;n--;)p(this.inTxnValues[t[n]][0])}});var Tt=null,xt={equals:e};n(t,$()),t.withEquality=function(t){return $({equals:t})},t["default"]=t});
//# sourceMappingURL=derivable.min.js.map