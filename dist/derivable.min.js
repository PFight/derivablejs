"use strict";function t(t){for(var n=1;n<arguments.length;n++)for(var e=arguments[n],r=W(e||{}),i=r.length;i--;){var u=r[i];t[u]=e[u]}return t}function n(t,n){return t===n?0!==t||1/t===1/n:t!==t&&n!==n}function e(t,e){return n(t,e)||t&&"function"==typeof t.equals&&t.equals(e)}function r(t,n){var e=t.indexOf(n);e<0&&t.push(n)}function i(t,n){var e=t.indexOf(n);e>=0&&t.splice(e,1)}function u(){return Y++}function o(t,n){return Array.prototype.slice.call(t,n)}function s(t){return null!==t&&void 0!==t}function a(t){$=!!t}function c(t,n){return t._equals=n,t}function f(t){return t&&(t._type===nt||t._type===tt||t._type===et)}function h(t){return t&&(t._type===tt||t._type===et)}function l(t){return t&&(t._type===nt||t._type===et)}function _(t){return t&&t._type===et}function p(t){at.push([]),ct=t}function v(){return at[at.length-1]}function d(){at.pop(),ct=null}function g(t){null!==ct&&(at[at.length-1].push(t),r(t._activeChildren,ct))}function y(t,n){for(var e=0,r=t._activeChildren.length;e<r;e++){var i=t._activeChildren[e];switch(i._type){case nt:case et:i._state!==it&&(i._state=it,y(i,n));break;case rt:n.push(i);break;default:throw new Error("Unrecognized child type")}}}function m(t){for(var n=0,e=t.length;n<e;n++){var r=t[n];if(r._reacting)throw new Error("Synchronous cyclical reactions disallowed. Use setImmediate.");r._maybeReact()}}function w(){throw ft}function E(t){this.parent=t,this.id2originalValue={},this.modifiedAtoms=[]}function b(t){null!==ht&&(t._id in ht.id2originalValue||(ht.modifiedAtoms.push(t),ht.id2originalValue[t._id]=t._value))}function k(){return null!==ht}function q(t){D();try{t.call(null,w)}catch(n){if(R(),n!==ft)throw n;return}x()}function A(t){k()?t():q(t)}function O(t){return function(){var n,e=o(arguments,0),r=this;return q(function(){n=t.apply(r,e)}),n}}function C(t){return function(){var n,e=o(arguments,0),r=this;return A(function(){n=t.apply(r,e)}),n}}function D(){ht=new E(ht)}function x(){var t=ht;if(ht=t.parent,null===ht){var n=[];t.modifiedAtoms.forEach(function(e){e.__equals(e._value,t.id2originalValue[e._id])?e._state=ot:(e._state=ut,
y(e,n))}),m(n),t.modifiedAtoms.forEach(function(t){t._state=ot})}}function R(){var t=ht;ht=t.parent,t.modifiedAtoms.forEach(function(n){n._value=t.id2originalValue[n._id],n._state=ot,y(n,[])})}function j(){0===lt&&D(),lt++;var t=!1;return{tick:function(){if(t)throw new Error("trying to use ticker after release");x(),D()},reset:function(){if(t)throw new Error("trying to use ticker after release");R(),D()},release:function(){if(t)throw new Error("ticker already released");lt--,t=!0,0===lt&&x()}}}function T(t){this._deriver=t,this._parents=null,this._type=nt,this._value=Z,this._equals=null,this._activeChildren=[],this._state=st,$&&(this.stack=Error().stack)}function V(t,n){if(i(t._activeChildren,n),0===t._activeChildren.length&&null!=t._parents){for(var e=t._parents.length,r=0;r<e;r++)V(t._parents[r],t);t._parents=null,t._state=st}}function z(t){return new T(t)}function F(t,n,e){this._parent=t,n&&(this.react=n),this._governor=e||null,this._active=!1,this._reacting=!1,this._type=rt,$&&(this.stack=Error().stack)}function I(t,n,e){function r(t,n){if(!f(t)){if("function"==typeof t)return z(t);if("boolean"==typeof t)return z(function(){return t});throw Error("react "+n+" condition must be derivable, got: "+JSON.stringify(t))}return t}if("function"!=typeof n)throw Error("the first argument to .react must be a function");e=X({once:!1,from:!0,until:!1,when:!0,skipFirst:!1},e);var i=new F(t,function(t){e.skipFirst?e.skipFirst=!1:(n(t),e.once&&(this.stop(),a.stop()))}),u=r(e.until,"until"),o=r(e.when,"when"),s=z(function(){return{until:u.get(),when:o.get()}}),a=new F(s,function(t){t.until?(i.stop(),this.stop()):t.when?i._active||i.start().force():i._active&&i.stop()});i._governor=a;var c=r(e.from,"from"),h=new F(c,function(t){t&&(a.start().force(),this.stop())});h.start().force()}function N(t){return this._id=u(),this._activeChildren=[],this._value=t,this._state=ot,this._type=tt,this._equals=null,this}function S(t){return new N(t)}function L(t){T.call(this,t.get),this._lensDescriptor=t,this._type=et}function M(t){return new L(t);
}function U(t){var n=o(arguments,1);return Et(function(){for(var e="",r=0;r<t.length;r++)e+=t[r],r<n.length&&(e+=J(n[r]));return e})}function J(t){return gt(t)?t.get():t}function B(t){return function(){var n=arguments,e=this;return Et(function(){return t.apply(e,Array.prototype.map.call(n,J))})}}function G(t){if(gt(t))return t.get();if(t instanceof Array)return t.map(G);if(t.constructor===Object){for(var n={},e=W(t),r=e.length;r--;){var i=e[r];n[i]=G(t[i])}return n}return t}function H(t){if(t.constructor===Object||t instanceof Array)return Et(function(){return G(t)});throw new Error("`struct` expects plain Object or Array")}function K(t){return function(){var n=arguments;return Et(function(){for(var e,r=0;r<n.length&&(e=J(n[r]),!t(e));r++);return e})}}function P(t){return t}function Q(t){return function(n){return!t(n)}}var W=Object.keys,X=Object.assign;X||(X=t);var Y=0,Z=Object.freeze({equals:function(){return!1}}),$=!1,tt="ATOM",nt="DERIVATION",et="LENS",rt="REACTOR",it=0,ut=1,ot=2,st=3,at=[],ct=null,ft={},ht=null,lt=0;X(T.prototype,{_clone:function(){return c(z(this._deriver),this._equals)},_forceEval:function(){var t=this,n=null,e=null;try{if(p(this),$)try{n=t._deriver()}catch(r){throw console.error(t.stack),r}else n=t._deriver();e=v()}finally{d()}if(this._state=this.__equals(n,this._value)?ot:ut,this._parents)for(var i=this._parents.length,u=0;u<i;u++){var o=this._parents[u];e.indexOf(o)===-1&&V(o,this)}this._parents=e,this._value=n},_update:function(){if(null===this._parents)this._forceEval();else if(this._state===it)for(var t=this._parents.length,n=0;n<t;n++)if(this._parents[n]._state!==ot){this._forceEval();break}},get:function(){return this._activeChildren.length>0?(g(this),this._update(),this._value):this._deriver()}}),X(F.prototype,{start:function(){if(this._active)throw new Error("already active");return this._active=!0,r(this._parent._activeChildren,this),this._parent._state===st&&(this._parent._state=it),this._parent.get(),this},_force:function(t){try{this._reacting=!0,this.react(t)}catch(n){throw $&&console.error(this.stack),
n}finally{this._reacting=!1}},force:function(){return this._force(this._parent.get()),this},_maybeReact:function(){if(!this._reacting&&this._active&&(null!==this._governor&&this._governor._maybeReact(),this._active)){var t=this._parent.get();this._parent._state===ut&&this._force(t)}},stop:function(){return V(this._parent,this),this._active=!1,this}}),X(N.prototype,{_clone:function(){return c(S(this._value),this._equals)},set:function(t){b(this);var n=this._value;if(this._value=t,!k()&&!this.__equals(t,n))try{this._state=ut;var e=[];y(this,e),m(e)}finally{this._state=ot}},get:function(){return g(this),this._value}}),X(L.prototype,T.prototype,{_clone:function(){return c(new L(this._lensDescriptor),this._equals)},set:function(t){var n=this;return A(function(){n._lensDescriptor.set(t)}),this}});var _t=q,pt=a,vt=O,dt=j,gt=f,yt=h,mt=_,wt=l,Et=z,bt=S,kt=C,qt=A,At=M,Ot=K(P),Ct=K(s),Dt=K(Q(P)),xt=K(Q(s)),Rt=Object.freeze({transact:_t,setDebugMode:pt,transaction:vt,ticker:dt,isDerivable:gt,isAtom:yt,isLensed:mt,isDerivation:wt,derivation:Et,atom:bt,atomic:kt,atomically:qt,lens:At,derive:U,unpack:J,lift:B,struct:H,or:Ot,mOr:Ct,and:Dt,mAnd:xt}),jt={derive:function(t,n,e,r,i){var u=this;switch(arguments.length){case 0:throw new Error(".derive takes at least one argument");case 1:switch(typeof t){case"function":return Et(function(){return t(u.get())});case"string":case"number":return Et(function(){return u.get()[J(t)]});default:if(t instanceof Array)return t.map(function(t){return u.derive(t)});if(t instanceof RegExp)return Et(function(){return u.get().match(t)});if(f(t))return Et(function(){var n=t.get(),e=u.get();switch(typeof n){case"function":return n(e);case"string":case"number":return e[n];default:if(n instanceof RegExp)return e.match(n);throw Error("type error")}});throw Error("type error")}case 2:return Et(function(){return t(u.get(),J(n))});case 3:return Et(function(){return t(u.get(),J(n),J(e))});case 4:return Et(function(){return t(u.get(),J(n),J(e),J(r))});case 5:return Et(function(){return t(u.get(),J(n),J(e),J(r),J(i));
});default:var s=[u].concat(o(arguments,1));return Et(function(){return t.apply(null,s.map(J))})}},react:function(t,n){I(this,t,n)},is:function(t){return B(this._equals||e)(this,t)},and:function(t){return this.derive(function(n){return n&&J(t)})},or:function(t){return this.derive(function(n){return n||J(t)})},then:function(t,n){return this.derive(function(e){return J(e?t:n)})},mThen:function(t,n){return this.derive(function(e){return J(s(e)?t:n)})},mOr:function(t){return this.mThen(this,t)},mDerive:function(t){if(1===arguments.length&&t instanceof Array){var n=this;return t.map(function(t){return n.mDerive(t)})}return this.mThen(this.derive.apply(this,arguments))},mAnd:function(t){return this.mThen(t,this)},not:function(){return this.derive(function(t){return!t})},withEquality:function(t){if(t){if("function"!=typeof t)throw new Error("equals must be function")}else t=null;return c(this._clone(),t)},__equals:function(t,n){return(this._equals||e)(t,n)}};jt["switch"]=function(){var t=arguments,n=this;return this.derive(function(e){var r;for(r=0;r<t.length-1;r+=2)if(n.__equals(e,J(t[r])))return J(t[r+1]);if(r===t.length-1)return J(t[r])})};var Tt={swap:function(t){var n=o(arguments,0);return n[0]=this.get(),this.set(t.apply(null,n))},lens:function(t){var n=this;return new L({get:function(){return t.get(n.get())},set:function(e){n.set(t.set(n.get(),e))}})}};X(T.prototype,jt),X(L.prototype,jt,Tt),X(N.prototype,jt,Tt),module.exports=Rt,module.exports=Rt;
//# sourceMappingURL=dist/derivable.min.js.map
//# sourceMappingURL=derivable.min.js.map