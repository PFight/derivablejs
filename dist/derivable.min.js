"use strict";function t(t){for(var e=1;e<arguments.length;e++)for(var n=arguments[e],r=X(n||{}),i=r.length;i--;){var s=r[i];t[s]=n[s]}return t}function e(t,e){return t===e?0!==t||1/t===1/e:t!==t&&e!==e}function n(t,n){return e(t,n)||t&&"function"==typeof t.equals&&t.equals(n)}function r(t,e){var n=t.indexOf(e);n<0&&t.push(e)}function i(t,e){var n=t.indexOf(e);n>=0&&t.splice(n,1)}function s(){return Y++}function o(t,e){return Array.prototype.slice.call(t,e)}function u(t){return null!==t&&void 0!==t}function a(t){$=!!t}function c(t,e){return t._equals=e,t}function f(t){return t&&(t._type===et||t._type===tt||t._type===nt)}function h(t){return t&&(t._type===tt||t._type===nt)}function l(t){return t&&(t._type===et||t._type===nt)}function p(t){return t&&t._type===nt}function _(t,e){at.push({parents:e,offset:0,child:t}),ct=t}function v(){return at[at.length-1]}function d(){at.pop(),ct=0===at.length?null:at[at.length-1].child}function g(t){if(null!==ct){var e=at[at.length-1];if(e.parents[e.offset]===t)e.offset++;else{var n=e.parents.indexOf(t);if(n===-1)r(t._activeChildren,ct),e.parents.push(e.parents[e.offset]),e.parents[e.offset]=t,e.offset++;else if(n>e.offset){var i=e.parents[n];e.parents[n]=e.parents[e.offset],e.parents[e.offset]=i,e.offset++}}}}function y(t,e){for(var n=0,r=t._activeChildren.length;n<r;n++){var i=t._activeChildren[n];switch(i._type){case et:case nt:i._state!==it&&(i._state=it,y(i,e));break;case rt:e.push(i)}}}function m(t){for(var e=0,n=t.length;e<n;e++){var r=t[e];if(r._reacting)throw new Error("Synchronous cyclical reactions disallowed. Use setImmediate.");r._maybeReact()}}function w(){throw ft}function x(t){this.parent=t,this.id2originalValue={},this.modifiedAtoms=[]}function E(t){null!==ht&&(t._id in ht.id2originalValue||(ht.modifiedAtoms.push(t),ht.id2originalValue[t._id]=t._value))}function b(){return null!==ht}function k(t){D();try{t.call(null,w)}catch(e){if(R(),e!==ft)throw e;return}C()}function A(t){b()?t():k(t)}function q(t){return function(){var e,n=o(arguments,0),r=this;return k(function(){
e=t.apply(r,n)}),e}}function O(t){return function(){var e,n=o(arguments,0),r=this;return A(function(){e=t.apply(r,n)}),e}}function D(){ht=new x(ht)}function C(){var t=ht;if(ht=t.parent,null===ht){var e=[];t.modifiedAtoms.forEach(function(n){n.__equals(n._value,t.id2originalValue[n._id])?n._state=ot:(n._state=st,y(n,e))}),m(e),t.modifiedAtoms.forEach(function(t){t._state=ot})}}function R(){var t=ht;ht=t.parent,t.modifiedAtoms.forEach(function(e){e._value=t.id2originalValue[e._id],e._state=ot,y(e,[])})}function j(){0===lt&&D(),lt++;var t=!1;return{tick:function(){if(t)throw new Error("trying to use ticker after release");C(),D()},reset:function(){if(t)throw new Error("trying to use ticker after release");R(),D()},release:function(){if(t)throw new Error("ticker already released");lt--,t=!0,0===lt&&C()}}}function T(t){this._deriver=t,this._parents=null,this._type=et,this._value=Z,this._equals=null,this._activeChildren=[],this._state=ut,$&&(this.stack=Error().stack)}function V(t,e){if(i(t._activeChildren,e),0===t._activeChildren.length&&null!=t._parents){for(var n=t._parents.length,r=0;r<n;r++)V(t._parents[r],t);t._parents=null,t._state=ut}}function S(t){return new T(t)}function M(t,e,n){this._parent=t,this.react=e,this._governor=n||null,this._active=!1,this._reacting=!1,this._type=rt,$&&(this.stack=Error().stack)}function F(e,n,r){function i(t,e){if(!f(t)){if("function"==typeof t)return S(t);if("boolean"==typeof t)return S(function(){return t});throw Error("react "+e+" condition must be derivable, got: "+JSON.stringify(t))}return t}if("function"!=typeof n)throw Error("the first argument to .react must be a function");r=t({once:!1,from:!0,until:!1,when:!0,skipFirst:!1},r);var s=new M(e,function(t){r.skipFirst?r.skipFirst=!1:(n(t),r.once&&(this.stop(),c.stop()))}),o=i(r.until,"until"),u=i(r.when,"when"),a=S(function(){return{until:o.get(),when:u.get()}}),c=new M(a,function(t){t.until?(s.stop(),this.stop()):t.when?s._active||s.start().force():s._active&&s.stop()});s._governor=c;var h=i(r.from,"from"),l=new M(h,function(t){
t&&(c.start().force(),this.stop())});l.start().force()}function I(t){return this._id=s(),this._activeChildren=[],this._value=t,this._state=ot,this._type=tt,this._equals=null,this}function L(t){return new I(t)}function N(t){T.call(this,t.get),this._lensDescriptor=t,this._type=nt}function P(t){return new N(t)}function z(t){var e=o(arguments,1);return xt(function(){for(var n="",r=0;r<t.length;r++)n+=t[r],r<e.length&&(n+=J(e[r]));return n})}function J(t){return gt(t)?t.get():t}function U(t){return function(){var e=arguments,n=this;return xt(function(){return t.apply(n,Array.prototype.map.call(e,J))})}}function B(t){if(gt(t))return t.get();if(t instanceof Array)return t.map(B);if(t.constructor===Object){for(var e={},n=X(t),r=n.length;r--;){var i=n[r];e[i]=B(t[i])}return e}return t}function G(t){if(t.constructor===Object||t instanceof Array)return xt(function(){return B(t)});throw new Error("`struct` expects plain Object or Array")}function H(t,e){var n=e;return function(e){var r=t.call(this,e,n);return n=e,r}}function K(t){return function(){var e=arguments;return xt(function(){for(var n,r=0;r<e.length&&(n=J(e[r]),!t(n));r++);return n})}}function Q(t){return t}function W(t){return function(e){return!t(e)}}Object.defineProperty(exports,"__esModule",{value:!0});var X=Object.keys,Y=0,Z=Object.freeze({equals:function(){return!1}}),$=!1,tt="ATOM",et="DERIVATION",nt="LENS",rt="REACTOR",it=0,st=1,ot=2,ut=3,at=[],ct=null,ft={},ht=null,lt=0;t(T.prototype,{_clone:function(){return c(S(this._deriver),this._equals)},_forceEval:function(){var t,e=this,n=null;try{if(null===this._parents&&(this._parents=[]),_(this,this._parents),$)try{n=e._deriver()}catch(r){throw console.error(e.stack),r}else n=e._deriver();t=v().offset}finally{d()}for(this._state=this.__equals(n,this._value)?ot:st;t<this._parents.length;){var i=this._parents[t++];V(i,this)}this._value=n},_update:function(){if(null===this._parents)this._forceEval();else if(this._state===it)for(var t=this._parents.length,e=0;e<t;e++){var n=this._parents[e];if(n._state===it&&n._update(),
n._state===st){this._forceEval();break}}},get:function(){return this._activeChildren.length>0?(g(this),this._update(),this._value):this._deriver()}}),t(M.prototype,{start:function(){return this._active=!0,r(this._parent._activeChildren,this),this._parent.get(),this},_force:function(t){try{this._reacting=!0,this.react(t)}catch(e){throw $&&console.error(this.stack),e}finally{this._reacting=!1}},force:function(){return this._force(this._parent.get()),this},_maybeReact:function(){if(!this._reacting&&this._active&&(null!==this._governor&&this._governor._maybeReact(),this._active)){var t=this._parent.get();this._parent._state===st&&this._force(t)}},stop:function(){return V(this._parent,this),this._active=!1,this}}),t(I.prototype,{_clone:function(){return c(L(this._value),this._equals)},set:function(t){E(this);var e=this._value;if(this._value=t,!b()&&!this.__equals(t,e))try{this._state=st;var n=[];y(this,n),m(n)}finally{this._state=ot}},get:function(){return g(this),this._value}}),t(N.prototype,T.prototype,{_clone:function(){return c(new N(this._lensDescriptor),this._equals)},set:function(t){var e=this;return A(function(){e._lensDescriptor.set(t)}),this}});var pt=k,_t=a,vt=q,dt=j,gt=f,yt=h,mt=p,wt=l,xt=S,Et=L,bt=O,kt=A,At=P,qt=K(Q),Ot=K(u),Dt=K(W(Q)),Ct=K(W(u)),Rt=Object.freeze({transact:pt,setDebugMode:_t,transaction:vt,ticker:dt,isDerivable:gt,isAtom:yt,isLensed:mt,isDerivation:wt,derivation:xt,atom:Et,atomic:bt,atomically:kt,lens:At,derive:z,unpack:J,lift:U,struct:G,wrapPreviousState:H,or:qt,mOr:Ot,and:Dt,mAnd:Ct}),jt={derive:function(t,e,n,r,i){var s=this;switch(arguments.length){case 0:throw new Error(".derive takes at least one argument");case 1:switch(typeof t){case"function":return xt(function(){return t(s.get())});case"string":case"number":return xt(function(){return s.get()[J(t)]});default:if(t instanceof Array)return t.map(function(t){return s.derive(t)});if(t instanceof RegExp)return xt(function(){return s.get().match(t)});if(f(t))return xt(function(){var e=t.get(),n=s.get();switch(typeof e){case"function":return e(n);
case"string":case"number":return n[e];default:if(e instanceof RegExp)return n.match(e);throw Error("type error")}});throw Error("type error")}case 2:return xt(function(){return t(s.get(),J(e))});case 3:return xt(function(){return t(s.get(),J(e),J(n))});case 4:return xt(function(){return t(s.get(),J(e),J(n),J(r))});case 5:return xt(function(){return t(s.get(),J(e),J(n),J(r),J(i))});default:var u=[s].concat(o(arguments,1));return xt(function(){return t.apply(null,u.map(J))})}},react:function(t,e){F(this,t,e)},is:function(t){return U(this._equals||n)(this,t)},and:function(t){return this.derive(function(e){return e&&J(t)})},or:function(t){return this.derive(function(e){return e||J(t)})},then:function(t,e){return this.derive(function(n){return J(n?t:e)})},mThen:function(t,e){return this.derive(function(n){return J(u(n)?t:e)})},mOr:function(t){return this.mThen(this,t)},mDerive:function(t){if(1===arguments.length&&t instanceof Array){var e=this;return t.map(function(t){return e.mDerive(t)})}return this.mThen(this.derive.apply(this,arguments))},mAnd:function(t){return this.mThen(t,this)},not:function(){return this.derive(function(t){return!t})},withEquality:function(t){if(t){if("function"!=typeof t)throw new Error("equals must be function")}else t=null;return c(this._clone(),t)},__equals:function(t,e){return(this._equals||n)(t,e)}};jt["switch"]=function(){var t=arguments,e=this;return this.derive(function(n){var r;for(r=0;r<t.length-1;r+=2)if(e.__equals(n,J(t[r])))return J(t[r+1]);if(r===t.length-1)return J(t[r])})};var Tt={swap:function(t){var e=o(arguments,0);return e[0]=this.get(),this.set(t.apply(null,e))},lens:function(t){var e=this;return new N({get:function(){return t.get(e.get())},set:function(n){e.set(t.set(e.get(),n))}})}};t(T.prototype,jt),t(N.prototype,jt,Tt),t(I.prototype,jt,Tt);var Vt=pt,St=_t,Mt=vt,Ft=dt,It=gt,Lt=yt,Nt=mt,Pt=wt,zt=xt,Jt=Et,Ut=bt,Bt=kt,Gt=At,Ht=z,Kt=J,Qt=U,Wt=G,Xt=H,Yt=qt,Zt=Ot,$t=Dt,te=Ct;exports.transact=Vt,exports.setDebugMode=St,exports.transaction=Mt,exports.ticker=Ft,exports.isDerivable=It,
exports.isAtom=Lt,exports.isLensed=Nt,exports.isDerivation=Pt,exports.derivation=zt,exports.atom=Jt,exports.atomic=Ut,exports.atomically=Bt,exports.lens=Gt,exports.derive=Ht,exports.unpack=Kt,exports.lift=Qt,exports.struct=Wt,exports.wrapPreviousState=Xt,exports.or=Yt,exports.mOr=Zt,exports.and=$t,exports.mAnd=te,exports["default"]=Rt;
//# sourceMappingURL=dist/derivable.min.js.map
//# sourceMappingURL=derivable.min.js.map